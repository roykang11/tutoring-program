<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Earnings</title>
    <link rel="stylesheet" href="../styles.css">
  </head>
  <body>
    <header class="app-header">
      <div class="header-left">
        <div class="currency-selector">
          <label>Currency:</label>
          <select id="currencySelect">
              <option value="USD">USD ($)</option>
              <option value="KRW">KRW (‚Ç©)</option>
          </select>
          <span id="conversionRate" class="conversion-rate"></span>
        </div>
      </div>
      <nav class="nav">
        <a href="./calendar.html">Weekly Calendar</a>
        <a href="./students.html">Students</a>
        <a href="./earnings.html">Earnings</a>
      </nav>
    </header>
    <main class="container">
      <div class="toolbar card">
        <div class="date-nav" style="flex-shrink: 0;">
          <button id="prevWeek" class="nav-btn">‚Äπ</button>
          <span id="currentWeek" class="current-week" style="min-width: 140px; display: inline-block; text-align: center;">October 2025</span>
          <button id="nextWeek" class="nav-btn">‚Ä∫</button>
          <button id="todayBtn" class="today-btn">Today</button>
        </div>
        <label for="weekSelect" style="margin-left: 16px; flex-shrink: 0;">Week:</label>
        <select id="weekSelect" style="background: white; border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; font-size: 13px; color: var(--fg); cursor: pointer; width: 150px; flex-shrink: 0;">
          <option value="">Select a week...</option>
        </select>
        <div class="spacer"></div>
        <div class="badge" id="totalWeek"></div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Student</th>
              <th>Hours</th>
              <th>Rate</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="earningsBody"></tbody>
          <tfoot>
            <tr>
              <th colspan="3" style="text-align:right">Net total</th>
              <th id="netTotal"></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="card" style="margin-top:16px; text-align:center; padding:32px; background: linear-gradient(135deg, #FFD700, #FFA500); border: 3px solid #B8860B; box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);">
        <h2 style="margin-bottom:20px; color:#8B4513; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-size:24px; font-weight:700">üí∞ TOTAL EARNINGS üí∞</h2>
        <div id="totalEarnings" style="font-size:64px; font-weight:900; color:#8B4513; font-family:'Courier New', monospace; letter-spacing:4px; margin:24px 0; text-shadow: 3px 3px 6px rgba(0,0,0,0.4); transform: perspective(500px) rotateX(15deg);">
          ‚Ç©0
        </div>
        <div class="muted" style="font-size:16px; color:#8B4513; font-weight:600; text-shadow: 1px 1px 2px rgba(0,0,0,0.2)">Total for this month</div>
        <div style="margin-top:12px; font-size:14px; color:#8B4513; font-style:italic; opacity:0.9">"Teaching minds, earning coins, living the dream! üéìüí∞"</div>
      </div>

      <div class="card" style="margin-top:16px; text-align:center; padding:32px; background: linear-gradient(135deg, #FFB6C1, #FF69B4); border: 3px solid #C71585; box-shadow: 0 8px 32px rgba(255, 105, 180, 0.3);">
        <h2 style="margin-bottom:20px; color:#8B008B; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-size:24px; font-weight:700">‚úàÔ∏è ITALY TRIP SAVINGS ‚úàÔ∏è</h2>
        <div id="italySavings" style="font-size:64px; font-weight:900; color:#8B008B; font-family:'Courier New', monospace; letter-spacing:4px; margin:24px 0; text-shadow: 3px 3px 6px rgba(0,0,0,0.4); transform: perspective(500px) rotateX(15deg);">
          ‚Ç©0
        </div>
        <div class="muted" style="font-size:16px; color:#8B008B; font-weight:600; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); margin-bottom:24px">Your savings goal for Italy!</div>
        
        <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:24px">
          <div style="display:flex; gap:8px; align-items:center">
            <input type="number" id="addAmount" placeholder="Amount (‚Ç©)" style="padding:10px 16px; border:2px solid #C71585; border-radius:8px; font-size:16px; width:150px; background:rgba(255,255,255,0.9); color:#8B008B; font-weight:600" min="0" step="1000">
            <button id="addSavingsBtn" style="padding:10px 20px; background:#C71585; color:white; border:none; border-radius:8px; font-size:16px; font-weight:700; cursor:pointer; box-shadow: 0 4px 8px rgba(199,21,133,0.4); transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Add Money</button>
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <input type="number" id="subtractAmount" placeholder="Amount (‚Ç©)" style="padding:10px 16px; border:2px solid #C71585; border-radius:8px; font-size:16px; width:150px; background:rgba(255,255,255,0.9); color:#8B008B; font-weight:600" min="0" step="1000">
            <button id="subtractSavingsBtn" style="padding:10px 20px; background:#8B008B; color:white; border:none; border-radius:8px; font-size:16px; font-weight:700; cursor:pointer; box-shadow: 0 4px 8px rgba(139,0,139,0.4); transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Subtract Money</button>
          </div>
          <button id="autoAddEarningsBtn" style="padding:10px 20px; background:linear-gradient(135deg, #FF69B4, #C71585); color:white; border:none; border-radius:8px; font-size:16px; font-weight:700; cursor:pointer; box-shadow: 0 4px 8px rgba(199,21,133,0.4); transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Add Monthly Earnings</button>
        </div>
        <div style="margin-top:12px; font-size:14px; color:#8B008B; font-style:italic; opacity:0.9">"Dreaming of pasta, saving every won! üçùüí∞"</div>
      </div>
    </main>

    <script src="../js/globals.js"></script>
    <script>

      const weekSelect = document.getElementById('weekSelect');
      const body = document.getElementById('earningsBody');
      const currencySelect = document.getElementById('currencySelect');
      const conversionRateDiv = document.getElementById('conversionRate');
      const currentWeek = document.getElementById('currentWeek');
      const prevWeekBtn = document.getElementById('prevWeek');
      const nextWeekBtn = document.getElementById('nextWeek');
      const todayBtn = document.getElementById('todayBtn');
      
      let currentExchangeRate = 1300; // Default fallback rate
      let selectedCurrency = 'USD';
      let currentWeekSunday = App.getSunday(new Date());

      // Italy Savings Storage
      const KEY_ITALY_SAVINGS = 'tp:italySavings';
      function getSavings() {
        try {
          const raw = localStorage.getItem(KEY_ITALY_SAVINGS);
          return raw ? parseFloat(raw) : 0;
        } catch {
          return 0;
        }
      }
      function saveSavings(amount) {
        localStorage.setItem(KEY_ITALY_SAVINGS, amount.toString());
      }
      function addToSavings(amount) {
        const current = getSavings();
        saveSavings(current + amount);
        displaySavings();
      }
      function subtractFromSavings(amount) {
        const current = getSavings();
        const newAmount = Math.max(0, current - amount); // Don't go below 0
        saveSavings(newAmount);
        displaySavings();
      }
      function displaySavings() {
        const savings = getSavings();
        const element = document.getElementById('italySavings');
        const current = parseFloat(element.textContent.replace(/[‚Ç©,]/g, '')) || 0;
        
        // Animate the counter
        const duration = 1000;
        const startTime = performance.now();
        
        function update(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const easeOut = 1 - Math.pow(1 - progress, 3);
          const animatedValue = current + (savings - current) * easeOut;
          
          element.textContent = `‚Ç©${Math.floor(animatedValue).toLocaleString()}`;
          
          if (progress < 1) {
            requestAnimationFrame(update);
          }
        }
        
        requestAnimationFrame(update);
      }

      // Get real-time USD to KRW exchange rate
      async function getExchangeRate() {
        try {
          const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
          const data = await response.json();
          currentExchangeRate = data.rates.KRW;
          updateConversionRateDisplay();
          return currentExchangeRate;
        } catch (error) {
          console.log('Using fallback exchange rate:', currentExchangeRate);
          updateConversionRateDisplay();
          return currentExchangeRate;
        }
      }

      function updateConversionRateDisplay() {
        if (selectedCurrency === 'KRW') {
          conversionRateDiv.textContent = `1 USD = ‚Ç©${Math.round(currentExchangeRate).toLocaleString()}`;
        } else {
          conversionRateDiv.textContent = `1 USD = ‚Ç©${Math.round(currentExchangeRate).toLocaleString()}`;
        }
      }

      function convertCurrency(amountUSD) {
        if (selectedCurrency === 'KRW') {
          return Math.round(amountUSD * currentExchangeRate);
        }
        return amountUSD;
      }

      function formatCurrency(amountUSD) {
        const amount = convertCurrency(amountUSD);
        if (selectedCurrency === 'KRW') {
          return `‚Ç©${amount.toLocaleString()}`;
        }
        return `$${amount.toFixed(2)}`;
      }

      function renderWeekLabel() {
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const sunday = App.getSunday(currentWeekSunday);
        const saturday = App.addDays(sunday, 6);
        if (sunday.getMonth() === saturday.getMonth()) {
          currentWeek.textContent = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
        } else {
          currentWeek.textContent = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
        }
      }

      function populateWeeks() {
        const allWeeks = Storage.getAllWeeks();
        const currentWeekKey = App.getWeekKey(currentWeekSunday);
        
        // Generate weeks for the past year and next year (like calendar page)
        const weeks = [];
        const today = new Date();
        const startDate = new Date(today);
        startDate.setFullYear(today.getFullYear() - 1);
        startDate.setDate(1);
        
        let currentDate = App.getSunday(startDate);
        const endDate = new Date(today);
        endDate.setFullYear(today.getFullYear() + 1);
        endDate.setMonth(11, 31);
        
        while (currentDate <= endDate) {
          const weekKey = App.getWeekKey(currentDate);
          const weekLabel = formatWeekLabel(currentDate);
          weeks.push({ key: weekKey, label: weekLabel, date: new Date(currentDate) });
          currentDate = App.addDays(currentDate, 7);
        }
        
        weekSelect.innerHTML = '<option value="">Select a week...</option>';
        weeks.forEach(week => {
          const option = document.createElement('option');
          option.value = week.key;
          option.textContent = week.label;
          if (week.key === currentWeekKey) {
            option.selected = true;
          }
          weekSelect.appendChild(option);
        });
      }

      function formatWeekLabel(date) {
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const sunday = App.getSunday(date);
        const saturday = App.addDays(sunday, 6);
        if (sunday.getMonth() === saturday.getMonth()) {
          return `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
        } else {
          return `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
        }
      }

      function updateWeekSelector() {
        const currentWeekKey = App.getWeekKey(currentWeekSunday);
        weekSelect.value = currentWeekKey;
      }

      function render() {
        const students = Storage.getStudents();
        const map = Object.fromEntries(students.map(s => [s.id, s]));
        const weekKey = App.getWeekKey(currentWeekSunday);
        const sessions = Storage.getSessionsByWeek(weekKey);
        
        if (!sessions || sessions.length === 0) {
          body.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center; padding:24px;">No sessions for this week. Add sessions in the calendar.</td></tr>';
          document.getElementById('netTotal').textContent = formatCurrency(0);
          const weekDateStr = weekKey.replace('week:', '');
          const weekDate = new Date(weekDateStr + 'T00:00');
          if (!isNaN(weekDate.getTime())) {
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const sunday = weekDate;
            const saturday = App.addDays(sunday, 6);
            let weekLabel;
            if (sunday.getMonth() === saturday.getMonth()) {
              weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
            } else {
              weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
            }
            document.getElementById('totalWeek').textContent = weekLabel;
          } else {
            document.getElementById('totalWeek').textContent = weekKey.replace('week:', '');
          }
          return;
        }
        const byStudent = new Map();
        sessions.forEach(s => {
          // Skip if no studentId
          if (!s.studentId) return;
          
          // Check if both start and end times exist - check for empty strings too
          const startTime = s.startTime ? String(s.startTime).trim() : '';
          const endTime = s.endTime ? String(s.endTime).trim() : '';
          
          if (!startTime || !endTime || startTime === '' || endTime === '') {
            return;
          }
          
          // Calculate hours from start and end times
          try {
            const startISO = `${s.dateISO.slice(0,10)}T${startTime}`;
            const endISO = `${s.dateISO.slice(0,10)}T${endTime}`;
            const hrs = App.hoursBetween(startISO, endISO);
            
            // Only count if hours calculation is valid and positive
            if (hrs > 0 && !isNaN(hrs) && isFinite(hrs)) {
              byStudent.set(s.studentId, (byStudent.get(s.studentId) || 0) + hrs);
            }
          } catch (error) {
            // Skip this session if calculation fails
          }
        });
        
        if (byStudent.size === 0 && sessions.length > 0) {
          // Sessions exist but no valid hours calculated (missing times)
          body.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center; padding:24px;">Sessions found but missing start/end times. Please add times to sessions.</td></tr>';
          document.getElementById('netTotal').textContent = formatCurrency(0);
          const weekDateStr = weekKey.replace('week:', '');
          const weekDate = new Date(weekDateStr + 'T00:00');
          if (!isNaN(weekDate.getTime())) {
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const sunday = weekDate;
            const saturday = App.addDays(sunday, 6);
            let weekLabel;
            if (sunday.getMonth() === saturday.getMonth()) {
              weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
            } else {
              weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
            }
            document.getElementById('totalWeek').textContent = weekLabel;
          } else {
            document.getElementById('totalWeek').textContent = weekKey.replace('week:', '');
          }
          return;
        } else if (byStudent.size === 0) {
          // This case is already handled above
          return;
        }
        let net = 0;
        body.innerHTML = Array.from(byStudent.entries()).map(([sid, hrs]) => {
          const st = map[sid];
          const rate = (st?.rate) || 0;
          const studentCurrency = st?.currency || 'USD';
            
          // Convert student rate to USD for calculation
          let rateUSD = rate;
          if (studentCurrency === 'KRW') {
            rateUSD = rate / currentExchangeRate;
            }
            
          const totalUSD = hrs * rateUSD;
          net += totalUSD;
          
          // Format display based on selected currency
          const displayRate = selectedCurrency === 'KRW' ? rateUSD * currentExchangeRate : rateUSD;
          const displayTotal = selectedCurrency === 'KRW' ? totalUSD * currentExchangeRate : totalUSD;
          
          const studentName = st?.name || sid;
          const colorDot = st?.color ? `<span class="color-dot" style="background:${st.color}; margin-right: 8px;"></span>` : '';
          return `<tr><td>${colorDot}${studentName}</td><td>${hrs.toFixed(2)}</td><td>${formatCurrency(displayRate)}</td><td>${formatCurrency(displayTotal)}</td></tr>`;
        }).join('');
          
        // Show both USD and KRW for net total
        const netKRW = Math.round(net * currentExchangeRate);
        document.getElementById('netTotal').textContent = `${formatCurrency(net)} (‚Ç©${netKRW.toLocaleString()})`;
        // Format week key for display
        const weekDateStr = weekKey.replace('week:', '');
        const weekDate = new Date(weekDateStr + 'T00:00');
        if (!isNaN(weekDate.getTime())) {
          const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
          const sunday = weekDate;
          const saturday = App.addDays(sunday, 6);
          let weekLabel;
          if (sunday.getMonth() === saturday.getMonth()) {
            weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
          } else {
            weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
          }
          document.getElementById('totalWeek').textContent = weekLabel;
        } else {
          document.getElementById('totalWeek').textContent = weekKey.replace('week:', '');
        }
        
        // Calculate total earnings for this month - sum all session earnings
        let grandTotalUSD = 0;
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        
        // Loop through all weeks and check each session's actual date
        const allWeeks = Storage.getAllWeeks();
        allWeeks.forEach(wk => {
          const weekSessions = Storage.getSessionsByWeek(wk);
          weekSessions.forEach(s => {
            // Skip if missing required data
            if (!s.studentId || !s.startTime || !s.endTime) {
              return;
            }
            
            // Check if this session's date is in the current month
            // Parse dateISO string (format: YYYY-MM-DDTHH:mm:ss.sssZ or YYYY-MM-DD)
            let sessionDate;
            try {
              const dateStr = s.dateISO.split('T')[0]; // Get just YYYY-MM-DD part
              sessionDate = new Date(dateStr + 'T00:00:00');
            } catch (e) {
              sessionDate = new Date(s.dateISO);
            }
            
            // Check if session is in current month
            if (sessionDate.getMonth() === currentMonth && sessionDate.getFullYear() === currentYear) {
              try {
                // Calculate hours from start and end times
                const dateStr = s.dateISO.split('T')[0]; // Get YYYY-MM-DD part
                const hrs = App.hoursBetween(`${dateStr}T${s.startTime}`, `${dateStr}T${s.endTime}`);
                
                if (hrs > 0 && !isNaN(hrs) && isFinite(hrs)) {
                  const st = map[s.studentId];
                  if (!st) return;
                  
                  const rate = st.rate || 0;
                  const studentCurrency = st.currency || 'USD';
          
                  // Convert student rate to USD for calculation
                  let rateUSD = rate;
                  if (studentCurrency === 'KRW') {
                    rateUSD = rate / currentExchangeRate;
                  }
          
                  // Calculate earnings for this session: hours √ó rate
                  const sessionEarningsUSD = hrs * rateUSD;
                  grandTotalUSD += sessionEarningsUSD;
                }
              } catch (error) {
                // Skip this session if calculation fails
              }
            }
          });
        });
        
        // Display total in KRW (always in Won)
        const totalAmountWon = grandTotalUSD * currentExchangeRate;
        animateCounter(document.getElementById('totalEarnings'), totalAmountWon);
      }
      
      function animateCounter(element, target) {
        const start = 0;
        const duration = 2000;
        const startTime = performance.now();
        
        function update(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const easeOut = 1 - Math.pow(1 - progress, 3);
          const current = start + (target - start) * easeOut;
          
          element.textContent = `‚Ç©${Math.floor(current).toLocaleString()}`;
          
          if (progress < 1) {
            requestAnimationFrame(update);
          }
        }
        
        requestAnimationFrame(update);
      }
      // Initialize the page
      async function init() {
        await getExchangeRate();
        renderWeekLabel();
        populateWeeks();
        render();
        displaySavings();
      }

      // Event listeners
      prevWeekBtn.addEventListener('click', () => {
        currentWeekSunday.setDate(currentWeekSunday.getDate() - 7);
        renderWeekLabel();
        updateWeekSelector();
        render();
      });
      
      nextWeekBtn.addEventListener('click', () => {
        currentWeekSunday.setDate(currentWeekSunday.getDate() + 7);
        renderWeekLabel();
        updateWeekSelector();
        render();
      });
      
      todayBtn.addEventListener('click', () => {
        currentWeekSunday = App.getSunday(new Date());
        renderWeekLabel();
        updateWeekSelector();
        render();
      });
      
      weekSelect.addEventListener('change', (e) => {
        const selectedKey = e.target.value;
        if (selectedKey) {
          const dateStr = selectedKey.replace('week:', '');
          currentWeekSunday = new Date(dateStr + 'T00:00');
          renderWeekLabel();
          render();
        }
      });

      // Italy Savings Event Listeners
      document.getElementById('addSavingsBtn').addEventListener('click', () => {
        const input = document.getElementById('addAmount');
        const amount = parseFloat(input.value);
        if (amount && amount > 0) {
          addToSavings(amount);
          input.value = '';
        } else {
          alert('Please enter a valid amount to add.');
        }
      });

      document.getElementById('subtractSavingsBtn').addEventListener('click', () => {
        const input = document.getElementById('subtractAmount');
        const amount = parseFloat(input.value);
        if (amount && amount > 0) {
          subtractFromSavings(amount);
          input.value = '';
        } else {
          alert('Please enter a valid amount to subtract.');
        }
      });

      document.getElementById('autoAddEarningsBtn').addEventListener('click', () => {
        // Calculate monthly earnings (same logic as totalEarnings)
        let monthlyEarningsUSD = 0;
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        
        const allWeeks = Storage.getAllWeeks();
        const students = Storage.getStudents();
        const map = {};
        students.forEach(s => { map[s.id] = s; });
        
        allWeeks.forEach(wk => {
          const weekSessions = Storage.getSessionsByWeek(wk);
          weekSessions.forEach(s => {
            if (!s.studentId || !s.startTime || !s.endTime) {
              return;
            }
            
            let sessionDate;
            try {
              const dateStr = s.dateISO.split('T')[0];
              sessionDate = new Date(dateStr + 'T00:00:00');
            } catch (e) {
              sessionDate = new Date(s.dateISO);
            }
            
            if (sessionDate.getMonth() === currentMonth && sessionDate.getFullYear() === currentYear) {
              try {
                const dateStr = s.dateISO.split('T')[0];
                const hrs = App.hoursBetween(`${dateStr}T${s.startTime}`, `${dateStr}T${s.endTime}`);
                
                if (hrs > 0 && !isNaN(hrs) && isFinite(hrs)) {
                  const st = map[s.studentId];
                  if (!st) return;
                  
                  const rate = st.rate || 0;
                  const studentCurrency = st.currency || 'USD';
          
                  let rateUSD = rate;
                  if (studentCurrency === 'KRW') {
                    rateUSD = rate / currentExchangeRate;
                  }
          
                  monthlyEarningsUSD += hrs * rateUSD;
                }
              } catch (error) {
                // Skip this session
              }
            }
          });
        });
        
        const monthlyEarningsKRW = monthlyEarningsUSD * currentExchangeRate;
        if (monthlyEarningsKRW > 0) {
          addToSavings(monthlyEarningsKRW);
          alert(`Added ‚Ç©${Math.floor(monthlyEarningsKRW).toLocaleString()} to your Italy trip savings! ‚úàÔ∏è`);
        } else {
          alert('No earnings found for this month to add.');
        }
      });

      // Allow Enter key to trigger add/subtract
      document.getElementById('addAmount').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('addSavingsBtn').click();
        }
      });

      document.getElementById('subtractAmount').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('subtractSavingsBtn').click();
        }
      });
      
      currencySelect.addEventListener('change', (e) => {
        selectedCurrency = e.target.value;
        updateConversionRateDisplay();
        render();
      });

      // Initialize
      init();
    </script>
  </body>
</html>


