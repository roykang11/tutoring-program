<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Earnings</title>
    <link rel="stylesheet" href="../styles.css">
  </head>
  <body>
    <header class="app-header">
      <div class="header-left">
        <div class="currency-selector">
          <label>Currency:</label>
          <select id="currencySelect">
              <option value="USD">USD ($)</option>
              <option value="KRW">KRW (‚Ç©)</option>
          </select>
          <span id="conversionRate" class="conversion-rate"></span>
        </div>
      </div>
      <nav class="nav">
        <a href="./calendar.html">Weekly Calendar</a>
        <a href="./students.html">Students</a>
        <a href="./earnings.html">Earnings</a>
      </nav>
    </header>
    <main class="container">
      <div class="toolbar card">
        <div class="date-nav" style="flex-shrink: 0;">
          <button id="prevWeek" class="nav-btn">‚Äπ</button>
          <span id="currentWeek" class="current-week" style="min-width: 140px; display: inline-block; text-align: center;">October 2025</span>
          <button id="nextWeek" class="nav-btn">‚Ä∫</button>
          <button id="todayBtn" class="today-btn">Today</button>
        </div>
        <label for="weekSelect" style="margin-left: 16px; flex-shrink: 0;">Week:</label>
        <select id="weekSelect" style="background: white; border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; font-size: 13px; color: var(--fg); cursor: pointer; width: 150px; flex-shrink: 0;">
          <option value="">Select a week...</option>
        </select>
        <div class="spacer"></div>
        <div class="badge" id="totalWeek"></div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Student</th>
              <th>Hours</th>
              <th>Rate</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="earningsBody"></tbody>
          <tfoot>
            <tr>
              <th colspan="3" style="text-align:right">Net total</th>
              <th id="netTotal"></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="card" style="margin-top:16px; text-align:center; padding:32px; background: linear-gradient(135deg, #FFD700, #FFA500); border: 3px solid #B8860B; box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);">
        <h2 style="margin-bottom:20px; color:#8B4513; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-size:24px; font-weight:700">üí∞ TOTAL EARNINGS üí∞</h2>
        <div id="totalEarnings" style="font-size:64px; font-weight:900; color:#8B4513; font-family:'Courier New', monospace; letter-spacing:4px; margin:24px 0; text-shadow: 3px 3px 6px rgba(0,0,0,0.4); transform: perspective(500px) rotateX(15deg);">
          ‚Ç©0
        </div>
        <div class="muted" style="font-size:16px; color:#8B4513; font-weight:600; text-shadow: 1px 1px 2px rgba(0,0,0,0.2)">Total for this month</div>
        <div style="margin-top:12px; font-size:14px; color:#8B4513; font-style:italic; opacity:0.9">"Teaching minds, earning coins, living the dream! üéìüí∞"</div>
      </div>

      <div class="card" style="margin-top:16px; text-align:center; padding:32px; background: linear-gradient(135deg, #FFB6C1, #FF69B4); border: 3px solid #C71585; box-shadow: 0 8px 32px rgba(255, 105, 180, 0.3);">
        <h2 style="margin-bottom:20px; color:#8B008B; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-size:24px; font-weight:700">‚úàÔ∏è ITALY TRIP SAVINGS ‚úàÔ∏è</h2>
        <div id="italySavings" style="font-size:64px; font-weight:900; color:#8B008B; font-family:'Courier New', monospace; letter-spacing:4px; margin:24px 0; text-shadow: 3px 3px 6px rgba(0,0,0,0.4); transform: perspective(500px) rotateX(15deg);">
          $0
        </div>
        <div class="muted" style="font-size:16px; color:#8B008B; font-weight:600; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); margin-bottom:24px">Your savings goal for Italy!</div>
        
        <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:24px">
          <div style="display:flex; gap:8px; align-items:center">
            <input type="number" id="addAmount" placeholder="Amount ($)" style="padding:10px 16px; border:2px solid #C71585; border-radius:8px; font-size:16px; width:150px; background:rgba(255,255,255,0.9); color:#8B008B; font-weight:600" min="0" step="0.01">
            <button id="addSavingsBtn" style="padding:10px 20px; background:#C71585; color:white; border:none; border-radius:8px; font-size:16px; font-weight:700; cursor:pointer; box-shadow: 0 4px 8px rgba(199,21,133,0.4); transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Add Money</button>
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <input type="number" id="subtractAmount" placeholder="Amount ($)" style="padding:10px 16px; border:2px solid #C71585; border-radius:8px; font-size:16px; width:150px; background:rgba(255,255,255,0.9); color:#8B008B; font-weight:600" min="0" step="0.01">
            <button id="subtractSavingsBtn" style="padding:10px 20px; background:#8B008B; color:white; border:none; border-radius:8px; font-size:16px; font-weight:700; cursor:pointer; box-shadow: 0 4px 8px rgba(139,0,139,0.4); transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Subtract Money</button>
          </div>
          <button id="viewDetailsBtn" style="padding:10px 20px; background:linear-gradient(135deg, #FF69B4, #C71585); color:white; border:none; border-radius:8px; font-size:16px; font-weight:700; cursor:pointer; box-shadow: 0 4px 8px rgba(199,21,133,0.4); transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">View Details</button>
        </div>
        <div style="margin-top:12px; font-size:14px; color:#8B008B; font-style:italic; opacity:0.9">"Dreaming of pasta, saving every dollar! üçùüí∞"</div>
      </div>
    </main>

    <script src="../js/globals.js"></script>
    <script>

      const weekSelect = document.getElementById('weekSelect');
      const body = document.getElementById('earningsBody');
      const currencySelect = document.getElementById('currencySelect');
      const conversionRateDiv = document.getElementById('conversionRate');
      const currentWeek = document.getElementById('currentWeek');
      const prevWeekBtn = document.getElementById('prevWeek');
      const nextWeekBtn = document.getElementById('nextWeek');
      const todayBtn = document.getElementById('todayBtn');
      
      let currentExchangeRate = 1300; // Default fallback rate
      let selectedCurrency = 'USD';
      let currentWeekSunday = App.getSunday(new Date());

      // Italy Savings Storage with Transaction History
      const KEY_ITALY_SAVINGS = 'tp:italySavings';
      const KEY_ITALY_TRANSACTIONS = 'tp:italyTransactions';
      
      function getTransactions() {
        try {
          const raw = localStorage.getItem(KEY_ITALY_TRANSACTIONS);
          return raw ? JSON.parse(raw) : [];
        } catch {
          return [];
        }
      }
      
      function saveTransactions(transactions) {
        localStorage.setItem(KEY_ITALY_TRANSACTIONS, JSON.stringify(transactions));
      }
      
      function getSavings() {
        // Calculate from transactions
        const transactions = getTransactions();
        return transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
      }
      
      function addTransaction(type, amount, description = '', sessionId = null) {
        const transactions = getTransactions();
        const transaction = {
          id: `trans_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`,
          type: type, // 'class', 'manual_add', 'manual_subtract'
          amount: amount, // positive for add, negative for subtract
          description: description,
          sessionId: sessionId,
          date: new Date().toISOString(),
          edited: false
        };
        transactions.push(transaction);
        saveTransactions(transactions);
        displaySavings();
        return transaction;
      }
      
      function updateTransaction(transactionId, newAmount, newDescription) {
        const transactions = getTransactions();
        const idx = transactions.findIndex(t => t.id === transactionId);
        if (idx >= 0) {
          transactions[idx].amount = newAmount;
          transactions[idx].description = newDescription;
          transactions[idx].edited = true;
          transactions[idx].dateEdited = new Date().toISOString();
          saveTransactions(transactions);
          displaySavings();
          return transactions[idx];
        }
        return null;
      }
      
      function deleteTransaction(transactionId) {
        const transactions = getTransactions();
        const filtered = transactions.filter(t => t.id !== transactionId);
        saveTransactions(filtered);
        displaySavings();
      }
      
      function addToSavings(amount, description = 'Manual addition') {
        addTransaction('manual_add', amount, description);
      }
      
      function subtractFromSavings(amount, description = 'Manual subtraction') {
        addTransaction('manual_subtract', -Math.abs(amount), description);
      }
      
      function displaySavings() {
        const savings = getSavings();
        const element = document.getElementById('italySavings');
        const current = parseFloat(element.textContent.replace(/[$,\s]/g, '')) || 0;
        
        // Animate the counter
        const duration = 1000;
        const startTime = performance.now();
        
        function update(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const easeOut = 1 - Math.pow(1 - progress, 3);
          const animatedValue = current + (savings - current) * easeOut;
          
          element.textContent = `$${animatedValue.toFixed(2)}`;
          
          if (progress < 1) {
            requestAnimationFrame(update);
          }
        }
        
        requestAnimationFrame(update);
      }

      // Get real-time USD to KRW exchange rate
      async function getExchangeRate() {
        try {
          const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
          const data = await response.json();
          currentExchangeRate = data.rates.KRW;
          // Store for use in student page
          localStorage.setItem('tp:exchangeRate', currentExchangeRate.toString());
          updateConversionRateDisplay();
          return currentExchangeRate;
        } catch (error) {
          console.log('Using fallback exchange rate:', currentExchangeRate);
          localStorage.setItem('tp:exchangeRate', currentExchangeRate.toString());
          updateConversionRateDisplay();
          return currentExchangeRate;
        }
      }

      function updateConversionRateDisplay() {
        if (selectedCurrency === 'KRW') {
          conversionRateDiv.textContent = `1 USD = ‚Ç©${Math.round(currentExchangeRate).toLocaleString()}`;
        } else {
          conversionRateDiv.textContent = `1 USD = ‚Ç©${Math.round(currentExchangeRate).toLocaleString()}`;
        }
      }

      function convertCurrency(amountUSD) {
        if (selectedCurrency === 'KRW') {
          return Math.round(amountUSD * currentExchangeRate);
        }
        return amountUSD;
      }

      function formatCurrency(amountUSD) {
        const amount = convertCurrency(amountUSD);
        if (selectedCurrency === 'KRW') {
          return `‚Ç©${amount.toLocaleString()}`;
        }
        return `$${amount.toFixed(2)}`;
      }

      function renderWeekLabel() {
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const sunday = App.getSunday(currentWeekSunday);
        const saturday = App.addDays(sunday, 6);
        if (sunday.getMonth() === saturday.getMonth()) {
          currentWeek.textContent = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
        } else {
          currentWeek.textContent = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
        }
      }

      function populateWeeks() {
        const allWeeks = Storage.getAllWeeks();
        const currentWeekKey = App.getWeekKey(currentWeekSunday);
        
        // Generate weeks for the past year and next year (like calendar page)
        const weeks = [];
        const today = new Date();
        const startDate = new Date(today);
        startDate.setFullYear(today.getFullYear() - 1);
        startDate.setDate(1);
        
        let currentDate = App.getSunday(startDate);
        const endDate = new Date(today);
        endDate.setFullYear(today.getFullYear() + 1);
        endDate.setMonth(11, 31);
        
        while (currentDate <= endDate) {
          const weekKey = App.getWeekKey(currentDate);
          const weekLabel = formatWeekLabel(currentDate);
          weeks.push({ key: weekKey, label: weekLabel, date: new Date(currentDate) });
          currentDate = App.addDays(currentDate, 7);
        }
        
        weekSelect.innerHTML = '<option value="">Select a week...</option>';
        weeks.forEach(week => {
          const option = document.createElement('option');
          option.value = week.key;
          option.textContent = week.label;
          if (week.key === currentWeekKey) {
            option.selected = true;
          }
          weekSelect.appendChild(option);
        });
      }

      function formatWeekLabel(date) {
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const sunday = App.getSunday(date);
        const saturday = App.addDays(sunday, 6);
        if (sunday.getMonth() === saturday.getMonth()) {
          return `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
        } else {
          return `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
        }
      }

      function updateWeekSelector() {
        const currentWeekKey = App.getWeekKey(currentWeekSunday);
        weekSelect.value = currentWeekKey;
      }

      function render() {
        const students = Storage.getStudents();
        const map = Object.fromEntries(students.map(s => [s.id, s]));
        const weekKey = App.getWeekKey(currentWeekSunday);
        const sessions = Storage.getSessionsByWeek(weekKey);
        
        if (!sessions || sessions.length === 0) {
          body.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center; padding:24px;">No sessions for this week. Add sessions in the calendar.</td></tr>';
          document.getElementById('netTotal').textContent = formatCurrency(0);
          const weekDateStr = weekKey.replace('week:', '');
          const weekDate = new Date(weekDateStr + 'T00:00');
          if (!isNaN(weekDate.getTime())) {
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const sunday = weekDate;
            const saturday = App.addDays(sunday, 6);
            let weekLabel;
            if (sunday.getMonth() === saturday.getMonth()) {
              weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
            } else {
              weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
            }
            document.getElementById('totalWeek').textContent = weekLabel;
          } else {
            document.getElementById('totalWeek').textContent = weekKey.replace('week:', '');
          }
          return;
        }
        const byStudent = new Map();
        sessions.forEach(s => {
          // Skip if no studentId
          if (!s.studentId) return;
          
          // Check if both start and end times exist - check for empty strings too
          const startTime = s.startTime ? String(s.startTime).trim() : '';
          const endTime = s.endTime ? String(s.endTime).trim() : '';
          
          if (!startTime || !endTime || startTime === '' || endTime === '') {
            return;
          }
          
          // Calculate hours from start and end times
          try {
            const startISO = `${s.dateISO.slice(0,10)}T${startTime}`;
            const endISO = `${s.dateISO.slice(0,10)}T${endTime}`;
            const hrs = App.hoursBetween(startISO, endISO);
            
            // Only count if hours calculation is valid and positive
            if (hrs > 0 && !isNaN(hrs) && isFinite(hrs)) {
              byStudent.set(s.studentId, (byStudent.get(s.studentId) || 0) + hrs);
            }
          } catch (error) {
            // Skip this session if calculation fails
          }
        });
        
        if (byStudent.size === 0 && sessions.length > 0) {
          // Sessions exist but no valid hours calculated (missing times)
          body.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center; padding:24px;">Sessions found but missing start/end times. Please add times to sessions.</td></tr>';
          document.getElementById('netTotal').textContent = formatCurrency(0);
          const weekDateStr = weekKey.replace('week:', '');
          const weekDate = new Date(weekDateStr + 'T00:00');
          if (!isNaN(weekDate.getTime())) {
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const sunday = weekDate;
            const saturday = App.addDays(sunday, 6);
            let weekLabel;
            if (sunday.getMonth() === saturday.getMonth()) {
              weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
            } else {
              weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
            }
            document.getElementById('totalWeek').textContent = weekLabel;
          } else {
            document.getElementById('totalWeek').textContent = weekKey.replace('week:', '');
          }
          return;
        } else if (byStudent.size === 0) {
          // This case is already handled above
          return;
        }
        let net = 0;
        body.innerHTML = Array.from(byStudent.entries()).map(([sid, hrs]) => {
          const st = map[sid];
          const rate = (st?.rate) || 0;
          const studentCurrency = st?.currency || 'USD';
            
          // Convert student rate to USD for calculation
          let rateUSD = rate;
          if (studentCurrency === 'KRW') {
            rateUSD = rate / currentExchangeRate;
            }
            
          const totalUSD = hrs * rateUSD;
          net += totalUSD;
          
          // Format display based on selected currency
          const displayRate = selectedCurrency === 'KRW' ? rateUSD * currentExchangeRate : rateUSD;
          const displayTotal = selectedCurrency === 'KRW' ? totalUSD * currentExchangeRate : totalUSD;
          
          const studentName = st?.name || sid;
          const colorDot = st?.color ? `<span class="color-dot" style="background:${st.color}; margin-right: 8px;"></span>` : '';
          return `<tr><td>${colorDot}${studentName}</td><td>${hrs.toFixed(2)}</td><td>${formatCurrency(displayRate)}</td><td>${formatCurrency(displayTotal)}</td></tr>`;
        }).join('');
          
        // Show both USD and KRW for net total
        const netKRW = Math.round(net * currentExchangeRate);
        document.getElementById('netTotal').textContent = `${formatCurrency(net)} (‚Ç©${netKRW.toLocaleString()})`;
        // Format week key for display
        const weekDateStr = weekKey.replace('week:', '');
        const weekDate = new Date(weekDateStr + 'T00:00');
        if (!isNaN(weekDate.getTime())) {
          const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
          const sunday = weekDate;
          const saturday = App.addDays(sunday, 6);
          let weekLabel;
          if (sunday.getMonth() === saturday.getMonth()) {
            weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
          } else {
            weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
          }
          document.getElementById('totalWeek').textContent = weekLabel;
        } else {
          document.getElementById('totalWeek').textContent = weekKey.replace('week:', '');
        }
        
        // Calculate total earnings for this month - sum all session earnings
        let grandTotalUSD = 0;
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        
        // Loop through all weeks and check each session's actual date
        const allWeeks = Storage.getAllWeeks();
        allWeeks.forEach(wk => {
          const weekSessions = Storage.getSessionsByWeek(wk);
          weekSessions.forEach(s => {
            // Skip if missing required data
            if (!s.studentId || !s.startTime || !s.endTime) {
              return;
            }
            
            // Check if this session's date is in the current month
            // Parse dateISO string (format: YYYY-MM-DDTHH:mm:ss.sssZ or YYYY-MM-DD)
            let sessionDate;
            try {
              const dateStr = s.dateISO.split('T')[0]; // Get just YYYY-MM-DD part
              sessionDate = new Date(dateStr + 'T00:00:00');
            } catch (e) {
              sessionDate = new Date(s.dateISO);
            }
            
            // Check if session is in current month
            if (sessionDate.getMonth() === currentMonth && sessionDate.getFullYear() === currentYear) {
              try {
                // Calculate hours from start and end times
                const dateStr = s.dateISO.split('T')[0]; // Get YYYY-MM-DD part
                const hrs = App.hoursBetween(`${dateStr}T${s.startTime}`, `${dateStr}T${s.endTime}`);
                
                if (hrs > 0 && !isNaN(hrs) && isFinite(hrs)) {
                  const st = map[s.studentId];
                  if (!st) return;
                  
                  const rate = st.rate || 0;
                  const studentCurrency = st.currency || 'USD';
          
                  // Convert student rate to USD for calculation
                  let rateUSD = rate;
                  if (studentCurrency === 'KRW') {
                    rateUSD = rate / currentExchangeRate;
                  }
          
                  // Calculate earnings for this session: hours √ó rate
                  const sessionEarningsUSD = hrs * rateUSD;
                  grandTotalUSD += sessionEarningsUSD;
                }
              } catch (error) {
                // Skip this session if calculation fails
              }
            }
          });
        });
        
        // Display total in KRW (always in Won)
        const totalAmountWon = grandTotalUSD * currentExchangeRate;
        animateCounter(document.getElementById('totalEarnings'), totalAmountWon);
      }
      
      function animateCounter(element, target) {
        const start = 0;
        const duration = 2000;
        const startTime = performance.now();
        
        function update(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const easeOut = 1 - Math.pow(1 - progress, 3);
          const current = start + (target - start) * easeOut;
          
          element.textContent = `‚Ç©${Math.floor(current).toLocaleString()}`;
          
          if (progress < 1) {
            requestAnimationFrame(update);
          }
        }
        
        requestAnimationFrame(update);
      }
      // Initialize the page
      async function init() {
        await getExchangeRate();
        renderWeekLabel();
        populateWeeks();
        render();
        displaySavings();
      }

      // Event listeners
      prevWeekBtn.addEventListener('click', () => {
        currentWeekSunday.setDate(currentWeekSunday.getDate() - 7);
        renderWeekLabel();
        updateWeekSelector();
        render();
      });
      
      nextWeekBtn.addEventListener('click', () => {
        currentWeekSunday.setDate(currentWeekSunday.getDate() + 7);
        renderWeekLabel();
        updateWeekSelector();
        render();
      });
      
      todayBtn.addEventListener('click', () => {
        currentWeekSunday = App.getSunday(new Date());
        renderWeekLabel();
        updateWeekSelector();
        render();
      });
      
      weekSelect.addEventListener('change', (e) => {
        const selectedKey = e.target.value;
        if (selectedKey) {
          const dateStr = selectedKey.replace('week:', '');
          currentWeekSunday = new Date(dateStr + 'T00:00');
          renderWeekLabel();
          render();
        }
      });

      // Italy Savings Event Listeners
      document.getElementById('addSavingsBtn').addEventListener('click', () => {
        const input = document.getElementById('addAmount');
        const amount = parseFloat(input.value);
        if (amount && amount > 0) {
          addToSavings(amount);
          input.value = '';
        } else {
          alert('Please enter a valid amount to add.');
        }
      });

      document.getElementById('subtractSavingsBtn').addEventListener('click', () => {
        const input = document.getElementById('subtractAmount');
        const amount = parseFloat(input.value);
        if (amount && amount > 0) {
          subtractFromSavings(amount);
          input.value = '';
        } else {
          alert('Please enter a valid amount to subtract.');
        }
      });

      // View Details Modal
      document.getElementById('viewDetailsBtn').addEventListener('click', () => {
        openDetailsModal();
      });
      
      function openDetailsModal() {
        const transactions = getTransactions().sort((a, b) => new Date(b.date) - new Date(a.date));
        const students = Storage.getStudents();
        const studentsMap = {};
        students.forEach(s => { studentsMap[s.id] = s; });
        
        const modalBackdrop = document.createElement('div');
        modalBackdrop.className = 'modal-backdrop';
        modalBackdrop.style.zIndex = '10000';
        
        let modalHTML = `
          <div class="modal" style="max-width:800px; max-height:90vh; overflow-y:auto">
            <header style="position:sticky; top:0; background:white; z-index:10; border-bottom:2px solid #C71585">
              <strong>Italy Savings Details</strong>
              <button id="closeDetailsModal" class="ghost">‚úï</button>
            </header>
            <div style="padding:20px">
              <div style="margin-bottom:20px; text-align:center; padding:16px; background:linear-gradient(135deg, #FFB6C1, #FF69B4); border-radius:8px">
                <div style="font-size:14px; color:#8B008B; margin-bottom:8px">Current Total Savings</div>
                <div style="font-size:36px; font-weight:700; color:#8B008B">$${getSavings().toFixed(2)}</div>
              </div>
              
              <h3 style="margin-bottom:16px; color:#8B008B">Transaction History</h3>
              <div id="transactionsList" style="max-height:400px; overflow-y:auto">
        `;
        
        if (transactions.length === 0) {
          modalHTML += `<div class="muted" style="text-align:center; padding:40px">No transactions yet</div>`;
        } else {
          transactions.forEach(t => {
            const date = new Date(t.date);
            const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const isPositive = t.amount > 0;
            const amountColor = isPositive ? '#28a745' : '#dc3545';
            let description = t.description;
            
            // If it's a class transaction, try to get student name
            if (t.type === 'class' && t.sessionId) {
              // Try to find session to get student info
              const allWeeks = Storage.getAllWeeks();
              for (const wk of allWeeks) {
                const sessions = Storage.getSessionsByWeek(wk);
                const session = sessions.find(s => s.id === t.sessionId);
                if (session) {
                  const student = studentsMap[session.studentId];
                  if (student) {
                    description = `Class: ${session.title || 'Untitled'} - ${student.name}`;
                  }
                  break;
                }
              }
            }
            
            modalHTML += `
              <div class="card" style="margin-bottom:12px; padding:16px; border-left:4px solid ${amountColor}">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px">
                  <div style="flex:1">
                    <div style="font-weight:600; margin-bottom:4px">${description}</div>
                    <div style="font-size:12px; color:#666">${dateStr}</div>
                    ${t.edited ? '<div style="font-size:11px; color:#999; font-style:italic">(Edited)</div>' : ''}
                  </div>
                  <div style="text-align:right; margin-left:16px">
                    <div style="font-size:20px; font-weight:700; color:${amountColor}">
                      ${isPositive ? '+' : ''}$${Math.abs(t.amount).toFixed(2)}
                    </div>
                  </div>
                </div>
                <div style="display:flex; gap:8px; margin-top:8px">
                  <button class="ghost" style="font-size:12px; padding:4px 8px" data-edit-trans="${t.id}">Edit</button>
                  <button class="ghost" style="font-size:12px; padding:4px 8px; color:#dc3545" data-delete-trans="${t.id}">Delete</button>
                </div>
              </div>
            `;
          });
        }
        
        modalHTML += `
              </div>
            </div>
          </div>
        `;
        
        modalBackdrop.innerHTML = modalHTML;
        document.body.appendChild(modalBackdrop);
        
        // Event listeners
        document.getElementById('closeDetailsModal').addEventListener('click', () => {
          document.body.removeChild(modalBackdrop);
        });
        
        modalBackdrop.addEventListener('click', (e) => {
          if (e.target === modalBackdrop) {
            document.body.removeChild(modalBackdrop);
          }
        });
        
        // Edit/Delete handlers
        modalBackdrop.addEventListener('click', (e) => {
          const editBtn = e.target.closest('[data-edit-trans]');
          const deleteBtn = e.target.closest('[data-delete-trans]');
          
          if (editBtn) {
            const transId = editBtn.dataset.editTrans;
            const transaction = transactions.find(t => t.id === transId);
            if (transaction) {
              openEditTransactionModal(transaction);
            }
          }
          
          if (deleteBtn) {
            const transId = deleteBtn.dataset.deleteTrans;
            if (confirm('Delete this transaction?')) {
              deleteTransaction(transId);
              document.body.removeChild(modalBackdrop);
              openDetailsModal(); // Refresh
            }
          }
        });
      }
      
      function openEditTransactionModal(transaction) {
        const editModal = document.createElement('div');
        editModal.className = 'modal-backdrop';
        editModal.style.zIndex = '10001';
        editModal.innerHTML = `
          <div class="modal" style="max-width:500px">
            <header><strong>Edit Transaction</strong><button id="closeEditTrans" class="ghost">‚úï</button></header>
            <div style="padding:20px">
              <div style="margin-bottom:16px">
                <label>Amount ($)</label>
                <input type="number" id="editTransAmount" value="${Math.abs(transaction.amount).toFixed(2)}" step="0.01" style="width:100%; padding:8px; margin-top:4px" />
              </div>
              <div style="margin-bottom:16px">
                <label>Description</label>
                <input type="text" id="editTransDesc" value="${transaction.description}" style="width:100%; padding:8px; margin-top:4px" />
              </div>
              <div style="display:flex; gap:8px; justify-content:flex-end">
                <button class="ghost" id="cancelEditTrans">Cancel</button>
                <button id="saveEditTrans">Save</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(editModal);
        
        document.getElementById('closeEditTrans').addEventListener('click', () => {
          document.body.removeChild(editModal);
        });
        
        document.getElementById('cancelEditTrans').addEventListener('click', () => {
          document.body.removeChild(editModal);
        });
        
        document.getElementById('saveEditTrans').addEventListener('click', () => {
          const newAmount = parseFloat(document.getElementById('editTransAmount').value);
          const newDesc = document.getElementById('editTransDesc').value.trim();
          
          if (isNaN(newAmount) || newAmount <= 0) {
            alert('Please enter a valid amount');
            return;
          }
          
          // Preserve the sign (positive or negative)
          const adjustedAmount = transaction.amount < 0 ? -newAmount : newAmount;
          
          updateTransaction(transaction.id, adjustedAmount, newDesc);
          document.body.removeChild(editModal);
          
          // Refresh details modal if it exists
          const detailsModal = document.querySelector('.modal-backdrop[style*="z-index: 10000"]');
          if (detailsModal) {
            document.body.removeChild(detailsModal);
            openDetailsModal();
          }
        });
        
        editModal.addEventListener('click', (e) => {
          if (e.target === editModal) {
            document.body.removeChild(editModal);
          }
        });
      }

      // Allow Enter key to trigger add/subtract
      document.getElementById('addAmount').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('addSavingsBtn').click();
        }
      });

      document.getElementById('subtractAmount').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          document.getElementById('subtractSavingsBtn').click();
        }
      });
      
      currencySelect.addEventListener('change', (e) => {
        selectedCurrency = e.target.value;
        updateConversionRateDisplay();
        render();
      });

      // Initialize
      init();
    </script>
  </body>
</html>


