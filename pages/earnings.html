<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Earnings</title>
    <link rel="stylesheet" href="../styles.css">
  </head>
  <body>
    <header class="app-header">
      <div class="header-left">
      <div class="currency-selector">
        <label>Currency:</label>
        <select id="currencySelect">
            <option value="USD">USD ($)</option>
            <option value="KRW">KRW (‚Ç©)</option>
        </select>
        <span id="conversionRate" class="conversion-rate"></span>
      </div>
        </div>
      <nav class="nav">
        <a href="./calendar.html">Weekly Calendar</a>
        <a href="./students.html">Students</a>
        <a href="./earnings.html">Earnings</a>
      </nav>
    </header>
    <main class="container">
      <div class="toolbar card">
        <div class="date-nav" style="flex-shrink: 0;">
          <button id="prevWeek" class="nav-btn">‚Äπ</button>
          <span id="currentWeek" class="current-week" style="min-width: 140px; display: inline-block; text-align: center;">October 2025</span>
          <button id="nextWeek" class="nav-btn">‚Ä∫</button>
          <button id="todayBtn" class="today-btn">Today</button>
        </div>
        <label for="weekSelect" style="margin-left: 16px; flex-shrink: 0;">Week:</label>
        <select id="weekSelect" style="background: white; border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; font-size: 13px; color: var(--fg); cursor: pointer; width: 150px; flex-shrink: 0;">
          <option value="">Select a week...</option>
        </select>
        <div class="spacer"></div>
        <div class="badge" id="totalWeek"></div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Student</th>
              <th>Hours</th>
              <th>Rate</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="earningsBody"></tbody>
          <tfoot>
            <tr>
              <th colspan="3" style="text-align:right">Net total</th>
              <th id="netTotal"></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="card" style="margin-top:16px; text-align:center; padding:32px; background: linear-gradient(135deg, #FFD700, #FFA500); border: 3px solid #B8860B; box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);">
        <h2 style="margin-bottom:20px; color:#8B4513; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-size:24px; font-weight:700">üí∞ TOTAL EARNINGS üí∞</h2>
        <div id="totalEarnings" style="font-size:64px; font-weight:900; color:#8B4513; font-family:'Courier New', monospace; letter-spacing:4px; margin:24px 0; text-shadow: 3px 3px 6px rgba(0,0,0,0.4); transform: perspective(500px) rotateX(15deg);">
          ‚Ç©0
        </div>
        <div class="muted" style="font-size:16px; color:#8B4513; font-weight:600; text-shadow: 1px 1px 2px rgba(0,0,0,0.2)">Total for this month</div>
        <div style="margin-top:12px; font-size:14px; color:#8B4513; font-style:italic; opacity:0.9">"Teaching minds, earning coins, living the dream! üéìüí∞"</div>
      </div>

      <div class="card" style="margin-top:16px; text-align:center; padding:32px; background: linear-gradient(135deg, #FFB6C1, #FF69B4); border: 3px solid #C71585; box-shadow: 0 8px 32px rgba(255, 105, 180, 0.3);">
        <h2 style="margin-bottom:20px; color:#8B008B; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-size:24px; font-weight:700">‚úàÔ∏è ITALY TRIP SAVINGS ‚úàÔ∏è</h2>
        <div id="italySavings" style="font-size:64px; font-weight:900; color:#8B008B; font-family:'Courier New', monospace; letter-spacing:4px; margin:24px 0; text-shadow: 3px 3px 6px rgba(0,0,0,0.4); transform: perspective(500px) rotateX(15deg);">
          $0
        </div>
        <div class="muted" style="font-size:16px; color:#8B008B; font-weight:600; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); margin-bottom:24px">Your savings goal for Italy!</div>
        
        <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:24px">
          <button id="addClassEarningsBtn" style="padding:10px 20px; background:linear-gradient(135deg, #FF69B4, #C71585); color:white; border:none; border-radius:8px; font-size:16px; font-weight:700; cursor:pointer; box-shadow: 0 4px 8px rgba(199,21,133,0.4); transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">‚ûï Add Class Earnings</button>
          <div style="display:flex; gap:8px; align-items:center">
            <input type="number" id="addAmount" placeholder="Amount" style="padding:10px 16px; border:2px solid #C71585; border-radius:8px; font-size:16px; width:150px; background:rgba(255,255,255,0.9); color:#8B008B; font-weight:600" min="0" step="0.01">
            <select id="addCurrencySelect" style="padding:10px 8px; border:2px solid #C71585; border-radius:8px; font-size:14px; background:rgba(255,255,255,0.9); color:#8B008B; font-weight:600; cursor:pointer">
              <option value="USD">USD</option>
              <option value="KRW">KRW</option>
            </select>
            <button id="addSavingsBtn" style="padding:10px 20px; background:#C71585; color:white; border:none; border-radius:8px; font-size:16px; font-weight:700; cursor:pointer; box-shadow: 0 4px 8px rgba(199,21,133,0.4); transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Add Money</button>
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <input type="number" id="subtractAmount" placeholder="Amount" style="padding:10px 16px; border:2px solid #C71585; border-radius:8px; font-size:16px; width:150px; background:rgba(255,255,255,0.9); color:#8B008B; font-weight:600" min="0" step="0.01">
            <select id="subtractCurrencySelect" style="padding:10px 8px; border:2px solid #C71585; border-radius:8px; font-size:14px; background:rgba(255,255,255,0.9); color:#8B008B; font-weight:600; cursor:pointer">
              <option value="USD">USD</option>
              <option value="KRW">KRW</option>
            </select>
            <button id="subtractSavingsBtn" style="padding:10px 20px; background:#8B008B; color:white; border:none; border-radius:8px; font-size:16px; font-weight:700; cursor:pointer; box-shadow: 0 4px 8px rgba(139,0,139,0.4); transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">Subtract Money</button>
          </div>
          <button id="viewDetailsBtn" style="padding:10px 20px; background:linear-gradient(135deg, #FF69B4, #C71585); color:white; border:none; border-radius:8px; font-size:16px; font-weight:700; cursor:pointer; box-shadow: 0 4px 8px rgba(199,21,133,0.4); transition:transform 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">View Details</button>
        </div>
        <div style="margin-top:12px; font-size:14px; color:#8B008B; font-style:italic; opacity:0.9">"Dreaming of pasta, saving every dollar! üçùüí∞"</div>
      </div>
    </main>

    <script src="../js/globals.js"></script>
    <script>

      const weekSelect = document.getElementById('weekSelect');
      const body = document.getElementById('earningsBody');
      const currencySelect = document.getElementById('currencySelect');
      const conversionRateDiv = document.getElementById('conversionRate');
      const currentWeek = document.getElementById('currentWeek');
      const prevWeekBtn = document.getElementById('prevWeek');
      const nextWeekBtn = document.getElementById('nextWeek');
      const todayBtn = document.getElementById('todayBtn');
      
      let currentExchangeRate = 1300; // Default fallback rate
      let selectedCurrency = 'USD';
      let currentWeekSunday = App.getSunday(new Date());

      // Italy Savings Storage with Transaction History
      const KEY_ITALY_SAVINGS = 'tp:italySavings';
      const KEY_ITALY_TRANSACTIONS = 'tp:italyTransactions';
      
      function getTransactions() {
        try {
          const raw = localStorage.getItem(KEY_ITALY_TRANSACTIONS);
          return raw ? JSON.parse(raw) : [];
        } catch {
          return [];
        }
      }
      
      function saveTransactions(transactions) {
        localStorage.setItem(KEY_ITALY_TRANSACTIONS, JSON.stringify(transactions));
      }
      
      function getSavings() {
        // Calculate from transactions
        const transactions = getTransactions();
        return transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
      }
      
      function addTransaction(type, amount, description = '', sessionId = null) {
        const transactions = getTransactions();
        const transaction = {
          id: `trans_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`,
          type: type, // 'class', 'manual_add', 'manual_subtract'
          amount: amount, // positive for add, negative for subtract
          description: description,
          sessionId: sessionId,
          date: new Date().toISOString(),
          edited: false
        };
        transactions.push(transaction);
        saveTransactions(transactions);
        displaySavings();
        return transaction;
      }
      
      function updateTransaction(transactionId, newAmount, newDescription) {
        const transactions = getTransactions();
        const idx = transactions.findIndex(t => t.id === transactionId);
        if (idx >= 0) {
          transactions[idx].amount = newAmount;
          transactions[idx].description = newDescription;
          transactions[idx].edited = true;
          transactions[idx].dateEdited = new Date().toISOString();
          saveTransactions(transactions);
          displaySavings();
          return transactions[idx];
        }
        return null;
      }
      
      function deleteTransaction(transactionId) {
        const transactions = getTransactions();
        const filtered = transactions.filter(t => t.id !== transactionId);
        saveTransactions(filtered);
        displaySavings();
      }
      
      function addToSavings(amount, description = 'Manual addition') {
        addTransaction('manual_add', amount, description);
      }
      
      function subtractFromSavings(amount, description = 'Manual subtraction') {
        addTransaction('manual_subtract', -Math.abs(amount), description);
      }
      
      function displaySavings() {
        const savings = getSavings();
        const element = document.getElementById('italySavings');
        const current = parseFloat(element.textContent.replace(/[$,\s]/g, '')) || 0;
        
        // Animate the counter
        const duration = 1000;
        const startTime = performance.now();
        
        function update(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const easeOut = 1 - Math.pow(1 - progress, 3);
          const animatedValue = current + (savings - current) * easeOut;
          
          element.textContent = `$${animatedValue.toFixed(2)}`;
          
          if (progress < 1) {
            requestAnimationFrame(update);
          }
        }
        
        requestAnimationFrame(update);
      }

      // Get real-time USD to KRW exchange rate
      async function getExchangeRate() {
        try {
          const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
          const data = await response.json();
          currentExchangeRate = data.rates.KRW;
          // Store for use in student page
          localStorage.setItem('tp:exchangeRate', currentExchangeRate.toString());
          updateConversionRateDisplay();
          return currentExchangeRate;
        } catch (error) {
          console.log('Using fallback exchange rate:', currentExchangeRate);
          localStorage.setItem('tp:exchangeRate', currentExchangeRate.toString());
          updateConversionRateDisplay();
          return currentExchangeRate;
        }
      }

      function updateConversionRateDisplay() {
        if (selectedCurrency === 'KRW') {
          conversionRateDiv.textContent = `1 USD = ‚Ç©${Math.round(currentExchangeRate).toLocaleString()}`;
        } else {
          conversionRateDiv.textContent = `1 USD = ‚Ç©${Math.round(currentExchangeRate).toLocaleString()}`;
        }
      }

      function convertCurrency(amountUSD) {
        if (selectedCurrency === 'KRW') {
          return Math.round(amountUSD * currentExchangeRate);
        }
        return amountUSD;
      }

      function formatCurrency(amountUSD) {
        const amount = convertCurrency(amountUSD);
        if (selectedCurrency === 'KRW') {
          return `‚Ç©${amount.toLocaleString()}`;
        }
        return `$${amount.toFixed(2)}`;
      }

      function renderWeekLabel() {
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const sunday = App.getSunday(currentWeekSunday);
        const saturday = App.addDays(sunday, 6);
        if (sunday.getMonth() === saturday.getMonth()) {
          currentWeek.textContent = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
        } else {
          currentWeek.textContent = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
        }
      }

      function populateWeeks() {
        const allWeeks = Storage.getAllWeeks();
        const currentWeekKey = App.getWeekKey(currentWeekSunday);
        
        // Generate weeks for the past year and next year (like calendar page)
        const weeks = [];
        const today = new Date();
        const startDate = new Date(today);
        startDate.setFullYear(today.getFullYear() - 1);
        startDate.setDate(1);
        
        let currentDate = App.getSunday(startDate);
        const endDate = new Date(today);
        endDate.setFullYear(today.getFullYear() + 1);
        endDate.setMonth(11, 31);
        
        while (currentDate <= endDate) {
          const weekKey = App.getWeekKey(currentDate);
          const weekLabel = formatWeekLabel(currentDate);
          weeks.push({ key: weekKey, label: weekLabel, date: new Date(currentDate) });
          currentDate = App.addDays(currentDate, 7);
        }
        
        weekSelect.innerHTML = '<option value="">Select a week...</option>';
        weeks.forEach(week => {
          const option = document.createElement('option');
          option.value = week.key;
          option.textContent = week.label;
          if (week.key === currentWeekKey) {
            option.selected = true;
          }
          weekSelect.appendChild(option);
        });
      }

      function formatWeekLabel(date) {
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const sunday = App.getSunday(date);
        const saturday = App.addDays(sunday, 6);
        if (sunday.getMonth() === saturday.getMonth()) {
          return `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
        } else {
          return `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
        }
      }

      function updateWeekSelector() {
        const currentWeekKey = App.getWeekKey(currentWeekSunday);
        weekSelect.value = currentWeekKey;
      }

      function render() {
        const students = Storage.getStudents();
        const map = Object.fromEntries(students.map(s => [s.id, s]));
        const weekKey = App.getWeekKey(currentWeekSunday);
        const sessions = Storage.getSessionsByWeek(weekKey);
        
        if (!sessions || sessions.length === 0) {
          body.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center; padding:24px;">No sessions for this week. Add sessions in the calendar.</td></tr>';
          document.getElementById('netTotal').textContent = formatCurrency(0);
          const weekDateStr = weekKey.replace('week:', '');
          const weekDate = new Date(weekDateStr + 'T00:00');
          if (!isNaN(weekDate.getTime())) {
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const sunday = weekDate;
            const saturday = App.addDays(sunday, 6);
            let weekLabel;
            if (sunday.getMonth() === saturday.getMonth()) {
              weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
            } else {
              weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
            }
            document.getElementById('totalWeek').textContent = weekLabel;
          } else {
            document.getElementById('totalWeek').textContent = weekKey.replace('week:', '');
          }
          return;
        }
        const byStudent = new Map();
        sessions.forEach(s => {
          // Skip if no studentId
          if (!s.studentId) return;
          
          // Check if both start and end times exist - check for empty strings too
          const startTime = s.startTime ? String(s.startTime).trim() : '';
          const endTime = s.endTime ? String(s.endTime).trim() : '';
          
          if (!startTime || !endTime || startTime === '' || endTime === '') {
            return;
          }
          
          // Calculate hours from start and end times
          try {
            const startISO = `${s.dateISO.slice(0,10)}T${startTime}`;
            const endISO = `${s.dateISO.slice(0,10)}T${endTime}`;
            const hrs = App.hoursBetween(startISO, endISO);
            
            // Only count if hours calculation is valid and positive
            if (hrs > 0 && !isNaN(hrs) && isFinite(hrs)) {
          byStudent.set(s.studentId, (byStudent.get(s.studentId) || 0) + hrs);
            }
          } catch (error) {
            // Skip this session if calculation fails
          }
        });
        
        if (byStudent.size === 0 && sessions.length > 0) {
          // Sessions exist but no valid hours calculated (missing times)
          body.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center; padding:24px;">Sessions found but missing start/end times. Please add times to sessions.</td></tr>';
          document.getElementById('netTotal').textContent = formatCurrency(0);
          const weekDateStr = weekKey.replace('week:', '');
          const weekDate = new Date(weekDateStr + 'T00:00');
          if (!isNaN(weekDate.getTime())) {
            const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            const sunday = weekDate;
            const saturday = App.addDays(sunday, 6);
            let weekLabel;
            if (sunday.getMonth() === saturday.getMonth()) {
              weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
            } else {
              weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
            }
            document.getElementById('totalWeek').textContent = weekLabel;
          } else {
            document.getElementById('totalWeek').textContent = weekKey.replace('week:', '');
          }
          return;
        } else if (byStudent.size === 0) {
          // This case is already handled above
          return;
        }
        let net = 0;
        body.innerHTML = Array.from(byStudent.entries())
          .filter(([sid, hrs]) => {
            // Filter out sessions for students that no longer exist
            const st = map[sid];
            return st !== undefined;
          })
          .map(([sid, hrs]) => {
          const st = map[sid];
          const rate = (st?.rate) || 0;
          const studentCurrency = st?.currency || 'USD';
            
          // Convert student rate to USD for calculation
          let rateUSD = rate;
          if (studentCurrency === 'KRW') {
            rateUSD = rate / currentExchangeRate;
            }
            
          const totalUSD = hrs * rateUSD;
          net += totalUSD;
          
            // formatCurrency expects USD amounts and will convert based on selectedCurrency
            const studentName = st?.name || sid;
            const colorDot = st?.color ? `<span class="color-dot" style="background:${st.color}; margin-right: 8px;"></span>` : '';
            return `<tr><td>${colorDot}${studentName}</td><td>${hrs.toFixed(2)}</td><td>${formatCurrency(rateUSD)}</td><td>${formatCurrency(totalUSD)}</td></tr>`;
        }).join('');
          
        // Show net total in selected currency
        document.getElementById('netTotal').textContent = formatCurrency(net);
        // Format week key for display
        const weekDateStr = weekKey.replace('week:', '');
        const weekDate = new Date(weekDateStr + 'T00:00');
        if (!isNaN(weekDate.getTime())) {
          const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
          const sunday = weekDate;
          const saturday = App.addDays(sunday, 6);
          let weekLabel;
          if (sunday.getMonth() === saturday.getMonth()) {
            weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
          } else {
            weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
          }
          document.getElementById('totalWeek').textContent = weekLabel;
        } else {
          document.getElementById('totalWeek').textContent = weekKey.replace('week:', '');
        }
        
        // Calculate total earnings for this month - sum all session earnings
        let grandTotalUSD = 0;
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        
        // Loop through all weeks and check each session's actual date
        const allWeeks = Storage.getAllWeeks();
        allWeeks.forEach(wk => {
            const weekSessions = Storage.getSessionsByWeek(wk);
            weekSessions.forEach(s => {
            // Skip if missing required data
            if (!s.studentId || !s.startTime || !s.endTime) {
              return;
            }
            
            // Check if this session's date is in the current month
            // Parse dateISO string (format: YYYY-MM-DDTHH:mm:ss.sssZ or YYYY-MM-DD)
            let sessionDate;
            try {
              const dateStr = s.dateISO.split('T')[0]; // Get just YYYY-MM-DD part
              sessionDate = new Date(dateStr + 'T00:00:00');
            } catch (e) {
              sessionDate = new Date(s.dateISO);
            }
            
            // Check if session is in current month
            if (sessionDate.getMonth() === currentMonth && sessionDate.getFullYear() === currentYear) {
              try {
                // Calculate hours from start and end times
                const dateStr = s.dateISO.split('T')[0]; // Get YYYY-MM-DD part
                const hrs = App.hoursBetween(`${dateStr}T${s.startTime}`, `${dateStr}T${s.endTime}`);
                
                if (hrs > 0 && !isNaN(hrs) && isFinite(hrs)) {
                  const st = map[s.studentId];
                  if (!st) return;
                  
                  const rate = st.rate || 0;
                  const studentCurrency = st.currency || 'USD';
          
              // Convert student rate to USD for calculation
              let rateUSD = rate;
              if (studentCurrency === 'KRW') {
                rateUSD = rate / currentExchangeRate;
          }
          
                  // Calculate earnings for this session: hours √ó rate
                  const sessionEarningsUSD = hrs * rateUSD;
                  grandTotalUSD += sessionEarningsUSD;
                }
              } catch (error) {
                // Skip this session if calculation fails
              }
            }
          });
        });
        
        // Display total in selected currency
        const totalAmount = selectedCurrency === 'KRW' ? grandTotalUSD * currentExchangeRate : grandTotalUSD;
        animateCounter(document.getElementById('totalEarnings'), totalAmount, selectedCurrency);
      }
      
      function animateCounter(element, target, currency = 'USD') {
        const start = 0;
        const duration = 2000;
        const startTime = performance.now();
        
        function update(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const easeOut = 1 - Math.pow(1 - progress, 3);
          const current = start + (target - start) * easeOut;
          
          if (currency === 'KRW') {
          element.textContent = `‚Ç©${Math.floor(current).toLocaleString()}`;
          } else {
            element.textContent = `$${current.toFixed(2)}`;
          }
          
          if (progress < 1) {
            requestAnimationFrame(update);
          }
        }
        
        requestAnimationFrame(update);
      }
      // Initialize the page
      async function init() {
        await getExchangeRate();
        renderWeekLabel();
        populateWeeks();
        render();
        displaySavings();
      }

      // Event listeners
      prevWeekBtn.addEventListener('click', () => {
        currentWeekSunday.setDate(currentWeekSunday.getDate() - 7);
        renderWeekLabel();
        updateWeekSelector();
        render();
      });
      
      nextWeekBtn.addEventListener('click', () => {
        currentWeekSunday.setDate(currentWeekSunday.getDate() + 7);
        renderWeekLabel();
        updateWeekSelector();
        render();
      });
      
      todayBtn.addEventListener('click', () => {
        currentWeekSunday = App.getSunday(new Date());
        renderWeekLabel();
        updateWeekSelector();
        render();
      });
      
      weekSelect.addEventListener('change', (e) => {
        const selectedKey = e.target.value;
        if (selectedKey) {
          const dateStr = selectedKey.replace('week:', '');
          currentWeekSunday = new Date(dateStr + 'T00:00');
          renderWeekLabel();
          render();
        }
      });

      // Italy Savings Event Listeners
      document.getElementById('addSavingsBtn').addEventListener('click', () => {
        const input = document.getElementById('addAmount');
        const currencySelect = document.getElementById('addCurrencySelect');
        const amount = parseFloat(input.value);
        const currency = currencySelect ? currencySelect.value : 'USD';
        
        if (amount && amount > 0) {
          // Convert to USD if needed (savings are stored in USD)
          let amountUSD = amount;
          if (currency === 'KRW') {
            amountUSD = amount / currentExchangeRate;
          }
          addToSavings(amountUSD);
          input.value = '';
        } else {
          alert('Please enter a valid amount to add.');
        }
      });

      document.getElementById('subtractSavingsBtn').addEventListener('click', () => {
        const input = document.getElementById('subtractAmount');
        const currencySelect = document.getElementById('subtractCurrencySelect');
        const amount = parseFloat(input.value);
        const currency = currencySelect ? currencySelect.value : 'USD';
        
        if (amount && amount > 0) {
          // Convert to USD if needed (savings are stored in USD)
          let amountUSD = amount;
          if (currency === 'KRW') {
            amountUSD = amount / currentExchangeRate;
          }
          subtractFromSavings(amountUSD);
          input.value = '';
        } else {
          alert('Please enter a valid amount to subtract.');
        }
      });

      // Add Class Earnings Modal
      const addClassEarningsBtn = document.getElementById('addClassEarningsBtn');
      if (addClassEarningsBtn) {
        addClassEarningsBtn.addEventListener('click', () => {
          console.log('Add Class Earnings button clicked');
          openAddClassEarningsModal();
        });
      }
      
      function openAddClassEarningsModal() {
        try {
          console.log('openAddClassEarningsModal called');
          const allWeeks = Storage.getAllWeeks();
          const students = Storage.getStudents();
          const studentsMap = {};
          students.forEach(s => { studentsMap[s.id] = s; });
        
        // Get all sessions with earnings info
        const allSessions = [];
        allWeeks.forEach(wk => {
          const sessions = Storage.getSessionsByWeek(wk);
          sessions.forEach(s => {
            if (!s.startTime || !s.endTime) return; // Skip sessions without times
            
            const student = studentsMap[s.studentId];
            if (!student) return;
            
            // Calculate earnings
            const dateStr = s.dateISO.split('T')[0];
            const hrs = App.hoursBetween(`${dateStr}T${s.startTime}`, `${dateStr}T${s.endTime}`);
            if (hrs <= 0 || isNaN(hrs) || !isFinite(hrs)) return;
            
            const rate = student.rate || 0;
            const studentCurrency = student.currency || 'USD';
            
            let rateUSD = rate;
            if (studentCurrency === 'KRW') {
              let exchangeRate = 1300;
              try {
                const rateData = localStorage.getItem('tp:exchangeRate');
                if (rateData) exchangeRate = parseFloat(rateData);
              } catch (e) {}
              rateUSD = rate / exchangeRate;
            }
            
            const earningsUSD = hrs * rateUSD;
            if (earningsUSD > 0) {
              allSessions.push({
                session: s,
                student: student,
                earnings: earningsUSD,
                date: new Date(s.dateISO),
                hours: hrs
              });
            }
          });
        });
        
        // Sort by date (newest first)
        allSessions.sort((a, b) => b.date - a.date);
        
        // Get already added session IDs
        const transactions = getTransactions();
        const addedSessionIds = new Set(
          transactions
            .filter(t => t.type === 'class' && t.sessionId)
            .map(t => t.sessionId)
        );
        
        const modalBackdrop = document.createElement('div');
        modalBackdrop.className = 'modal-backdrop';
        modalBackdrop.style.zIndex = '10000';
        modalBackdrop.style.display = 'flex';
        
        let modalHTML = `
          <div class="modal" style="max-width:700px; max-height:90vh; overflow-y:auto">
            <header style="position:sticky; top:0; background:white; z-index:10; border-bottom:2px solid #C71585">
              <strong>Add Class Earnings to Italy Savings</strong>
              <button id="closeAddClassModal" class="ghost">‚úï</button>
            </header>
            <div style="padding:20px">
              <div style="margin-bottom:16px">
                <label style="display:flex; align-items:center; gap:8px; margin-bottom:12px">
                  <input type="checkbox" id="selectAllClasses" style="width:20px; height:20px; cursor:pointer" />
                  <strong style="color:#8B008B">Select All</strong>
                </label>
              </div>
              <div id="classesList" style="max-height:500px; overflow-y:auto">
        `;
        
        if (allSessions.length === 0) {
          modalHTML += `<div class="muted" style="text-align:center; padding:40px">No classes with valid time data found</div>`;
        } else {
          allSessions.forEach(({session, student, earnings, date, hours}) => {
            const isAlreadyAdded = addedSessionIds.has(session.id);
            const dateStr = date.toLocaleDateString();
            const timeStr = `${session.startTime} - ${session.endTime}`;
            
            modalHTML += `
              <div class="card" style="margin-bottom:12px; padding:16px; ${isAlreadyAdded ? 'opacity:0.6; background:#f5f5f5' : ''}">
                <label style="display:flex; align-items:flex-start; gap:12px; cursor:${isAlreadyAdded ? 'not-allowed' : 'pointer'}">
                  <input 
                    type="checkbox" 
                    class="class-checkbox" 
                    data-session-id="${session.id}"
                    data-earnings="${earnings}"
                    data-session-title="${(session.title || 'Untitled').replace(/"/g, '&quot;')}"
                    data-student-name="${student.name.replace(/"/g, '&quot;')}"
                    ${isAlreadyAdded ? 'disabled' : ''}
                    style="width:20px; height:20px; cursor:${isAlreadyAdded ? 'not-allowed' : 'pointer'}; margin-top:2px; flex-shrink:0" 
                  />
                  <div style="flex:1">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:4px">
                      <div style="font-weight:600">${session.title || 'Untitled Class'}</div>
                      <div style="font-size:18px; font-weight:700; color:#28a745">+$${earnings.toFixed(2)}</div>
                    </div>
                    <div style="font-size:12px; color:#666; margin-bottom:4px">
                      ${student.name} ‚Ä¢ ${dateStr} ‚Ä¢ ${timeStr} ‚Ä¢ ${hours.toFixed(2)} hrs @ $${(earnings / hours).toFixed(2)}/hr
                    </div>
                    ${isAlreadyAdded ? '<div style="font-size:11px; color:#999; font-style:italic">Already added to savings</div>' : ''}
                  </div>
                </label>
              </div>
            `;
          });
        }
        
        modalHTML += `
              </div>
              <div style="margin-top:20px; padding-top:20px; border-top:2px solid #C71585">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
                  <strong style="color:#8B008B">Selected Total:</strong>
                  <div style="font-size:24px; font-weight:700; color:#28a745" id="selectedTotal">$0.00</div>
                </div>
                <div style="display:flex; gap:8px; justify-content:flex-end">
                  <button class="ghost" id="cancelAddClasses">Cancel</button>
                  <button id="addSelectedClasses" style="background:#C71585; color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:700; cursor:pointer">Add Selected to Savings</button>
                </div>
              </div>
            </div>
          </div>
        `;
        
        modalBackdrop.innerHTML = modalHTML;
        document.body.appendChild(modalBackdrop);
        
        // Calculate and update selected total
        function updateSelectedTotal() {
          const checkboxes = modalBackdrop.querySelectorAll('.class-checkbox:not(:disabled):checked');
          let total = 0;
          checkboxes.forEach(cb => {
            total += parseFloat(cb.dataset.earnings);
          });
          document.getElementById('selectedTotal').textContent = `$${total.toFixed(2)}`;
        }
        
        // Select all checkbox
        document.getElementById('selectAllClasses').addEventListener('change', (e) => {
          const checkboxes = modalBackdrop.querySelectorAll('.class-checkbox:not(:disabled)');
          checkboxes.forEach(cb => {
            cb.checked = e.target.checked;
          });
          updateSelectedTotal();
        });
        
        // Individual checkbox change
        modalBackdrop.addEventListener('change', (e) => {
          if (e.target.classList.contains('class-checkbox')) {
            updateSelectedTotal();
            // Uncheck select all if any individual is unchecked
            const selectAll = document.getElementById('selectAllClasses');
            const checkboxes = modalBackdrop.querySelectorAll('.class-checkbox:not(:disabled)');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            selectAll.checked = allChecked;
          }
        });
        
        // Close handlers
        document.getElementById('closeAddClassModal').addEventListener('click', () => {
          document.body.removeChild(modalBackdrop);
        });
        
        document.getElementById('cancelAddClasses').addEventListener('click', () => {
          document.body.removeChild(modalBackdrop);
        });
        
        modalBackdrop.addEventListener('click', (e) => {
          if (e.target === modalBackdrop) {
            document.body.removeChild(modalBackdrop);
          }
        });
        
        // Add selected classes
        document.getElementById('addSelectedClasses').addEventListener('click', () => {
          const checkboxes = modalBackdrop.querySelectorAll('.class-checkbox:not(:disabled):checked');
          if (checkboxes.length === 0) {
            alert('Please select at least one class to add');
            return;
          }
          
          let addedCount = 0;
          let totalAdded = 0;
          
          checkboxes.forEach(cb => {
            const sessionId = cb.dataset.sessionId;
            const earnings = parseFloat(cb.dataset.earnings);
            const sessionTitle = cb.dataset.sessionTitle;
            const studentName = cb.dataset.studentName;
            
            // Check if already added (shouldn't happen but just in case)
            if (addedSessionIds.has(sessionId)) return;
            
            addTransaction('class', earnings, `Class: ${sessionTitle} - ${studentName}`, sessionId);
            addedCount++;
            totalAdded += earnings;
          });
          
          if (addedCount > 0) {
            alert(`Added ${addedCount} class(es) totaling $${totalAdded.toFixed(2)} to your Italy savings! ‚úàÔ∏è`);
            document.body.removeChild(modalBackdrop);
            displaySavings(); // Refresh display
          }
        });
        
        // Initial total update
        updateSelectedTotal();
        } catch (error) {
          console.error('Error opening Add Class Earnings modal:', error);
          alert('Error opening class earnings modal. Please check the console for details.');
        }
      }

      // View Details Modal
      document.getElementById('viewDetailsBtn').addEventListener('click', () => {
        openDetailsModal();
      });
      
      function openDetailsModal() {
        try {
          const transactions = getTransactions().sort((a, b) => new Date(b.date) - new Date(a.date));
          const students = Storage.getStudents();
          const studentsMap = {};
          students.forEach(s => { studentsMap[s.id] = s; });
        
        const modalBackdrop = document.createElement('div');
        modalBackdrop.className = 'modal-backdrop';
        modalBackdrop.style.zIndex = '10000';
        modalBackdrop.style.display = 'flex';
        
        let modalHTML = `
          <div class="modal" style="max-width:800px; max-height:90vh; overflow-y:auto">
            <header style="position:sticky; top:0; background:white; z-index:10; border-bottom:2px solid #C71585">
              <strong>Italy Savings Details</strong>
              <button id="closeDetailsModal" class="ghost">‚úï</button>
            </header>
            <div style="padding:20px">
              <div style="margin-bottom:20px; text-align:center; padding:16px; background:linear-gradient(135deg, #FFB6C1, #FF69B4); border-radius:8px">
                <div style="font-size:14px; color:#8B008B; margin-bottom:8px">Current Total Savings</div>
                <div style="font-size:36px; font-weight:700; color:#8B008B">$${getSavings().toFixed(2)}</div>
              </div>
              
              <h3 style="margin-bottom:16px; color:#8B008B">Transaction History</h3>
              <div id="transactionsList" style="max-height:400px; overflow-y:auto">
        `;
        
        if (transactions.length === 0) {
          modalHTML += `<div class="muted" style="text-align:center; padding:40px">No transactions yet</div>`;
        } else {
          transactions.forEach(t => {
            const date = new Date(t.date);
            const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const isPositive = t.amount > 0;
            const amountColor = isPositive ? '#28a745' : '#dc3545';
            let description = t.description;
            
            // If it's a class transaction, try to get student name
            if (t.type === 'class' && t.sessionId) {
              // Try to find session to get student info
              const allWeeks = Storage.getAllWeeks();
              for (const wk of allWeeks) {
                const sessions = Storage.getSessionsByWeek(wk);
                const session = sessions.find(s => s.id === t.sessionId);
                if (session) {
                  const student = studentsMap[session.studentId];
                  if (student) {
                    description = `Class: ${session.title || 'Untitled'} - ${student.name}`;
                  }
                  break;
                }
              }
            }
            
            // Determine transaction type for better display
            let typeLabel = '';
            if (t.type === 'class') {
              typeLabel = '<span style="font-size:10px; background:#28a745; color:white; padding:2px 6px; border-radius:4px; margin-right:6px">CLASS</span>';
            } else if (t.type === 'manual_add') {
              typeLabel = '<span style="font-size:10px; background:#007bff; color:white; padding:2px 6px; border-radius:4px; margin-right:6px">ADDED</span>';
            } else if (t.type === 'manual_subtract') {
              typeLabel = '<span style="font-size:10px; background:#dc3545; color:white; padding:2px 6px; border-radius:4px; margin-right:6px">SUBTRACTED</span>';
            }
            
            modalHTML += `
              <div class="card" style="margin-bottom:12px; padding:16px; border-left:4px solid ${amountColor}">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px">
                  <div style="flex:1">
                    <div style="font-weight:600; margin-bottom:4px">${typeLabel}${description}</div>
                    <div style="font-size:12px; color:#666">${dateStr}</div>
                    ${t.edited ? '<div style="font-size:11px; color:#999; font-style:italic">(Edited on ' + new Date(t.dateEdited || t.date).toLocaleDateString() + ')</div>' : ''}
                  </div>
                  <div style="text-align:right; margin-left:16px">
                    <div style="font-size:20px; font-weight:700; color:${amountColor}">
                      ${isPositive ? '+' : ''}$${Math.abs(t.amount).toFixed(2)}
                    </div>
                  </div>
                </div>
                <div style="display:flex; gap:8px; margin-top:8px">
                  <button class="ghost" style="font-size:12px; padding:4px 8px; cursor:pointer" data-edit-trans="${t.id}">‚úèÔ∏è Edit</button>
                  <button class="ghost" style="font-size:12px; padding:4px 8px; color:#dc3545; cursor:pointer" data-delete-trans="${t.id}">üóëÔ∏è Delete</button>
                </div>
              </div>
            `;
          });
        }
        
        modalHTML += `
              </div>
            </div>
          </div>
        `;
        
        modalBackdrop.innerHTML = modalHTML;
        document.body.appendChild(modalBackdrop);
        
        // Event listeners
        document.getElementById('closeDetailsModal').addEventListener('click', () => {
          document.body.removeChild(modalBackdrop);
        });
        
        modalBackdrop.addEventListener('click', (e) => {
          if (e.target === modalBackdrop) {
            document.body.removeChild(modalBackdrop);
          }
        });
        
        // Edit/Delete handlers
        modalBackdrop.addEventListener('click', (e) => {
          const editBtn = e.target.closest('[data-edit-trans]');
          const deleteBtn = e.target.closest('[data-delete-trans]');
          
          if (editBtn) {
            const transId = editBtn.dataset.editTrans;
            const transaction = transactions.find(t => t.id === transId);
            if (transaction) {
              openEditTransactionModal(transaction);
            }
          }
          
          if (deleteBtn) {
            const transId = deleteBtn.dataset.deleteTrans;
            if (confirm('Delete this transaction?')) {
              deleteTransaction(transId);
              document.body.removeChild(modalBackdrop);
              openDetailsModal(); // Refresh
            }
          }
        });
        } catch (error) {
          console.error('Error opening Details modal:', error);
          alert('Error opening details modal. Please check the console for details.');
        }
      }
      
      function openEditTransactionModal(transaction) {
        const editModal = document.createElement('div');
        editModal.className = 'modal-backdrop';
        editModal.style.zIndex = '10001';
        editModal.style.display = 'flex';
        editModal.innerHTML = `
          <div class="modal" style="max-width:500px">
            <header><strong>Edit Transaction</strong><button id="closeEditTrans" class="ghost">‚úï</button></header>
            <div style="padding:20px">
              <div style="margin-bottom:16px">
                <label>Amount ($)</label>
                <input type="number" id="editTransAmount" value="${Math.abs(transaction.amount).toFixed(2)}" step="0.01" style="width:100%; padding:8px; margin-top:4px" />
              </div>
              <div style="margin-bottom:16px">
                <label>Description</label>
                <input type="text" id="editTransDesc" value="${transaction.description}" style="width:100%; padding:8px; margin-top:4px" />
              </div>
              <div style="display:flex; gap:8px; justify-content:flex-end">
                <button class="ghost" id="cancelEditTrans">Cancel</button>
                <button id="saveEditTrans">Save</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(editModal);
        
        document.getElementById('closeEditTrans').addEventListener('click', () => {
          document.body.removeChild(editModal);
        });
        
        document.getElementById('cancelEditTrans').addEventListener('click', () => {
          document.body.removeChild(editModal);
        });
        
        document.getElementById('saveEditTrans').addEventListener('click', () => {
          const newAmount = parseFloat(document.getElementById('editTransAmount').value);
          const newDesc = document.getElementById('editTransDesc').value.trim();
          
          if (isNaN(newAmount) || newAmount <= 0) {
            alert('Please enter a valid amount');
            return;
          }
          
          // Preserve the sign (positive or negative)
          const adjustedAmount = transaction.amount < 0 ? -newAmount : newAmount;
          
          updateTransaction(transaction.id, adjustedAmount, newDesc);
          document.body.removeChild(editModal);
          
          // Refresh details modal if it exists
          const detailsModal = document.querySelector('.modal-backdrop[style*="z-index: 10000"]');
          if (detailsModal) {
            document.body.removeChild(detailsModal);
            openDetailsModal();
          }
        });
        
        editModal.addEventListener('click', (e) => {
          if (e.target === editModal) {
            document.body.removeChild(editModal);
          }
        });
      }

      // Allow Enter key to trigger add/subtract
      const addAmountInput = document.getElementById('addAmount');
      if (addAmountInput) {
        addAmountInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            document.getElementById('addSavingsBtn').click();
          }
        });
      }

      const subtractAmountInput = document.getElementById('subtractAmount');
      if (subtractAmountInput) {
        subtractAmountInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            document.getElementById('subtractSavingsBtn').click();
          }
        });
      }
      
      currencySelect.addEventListener('change', (e) => {
        selectedCurrency = e.target.value;
        updateConversionRateDisplay();
        render();
        // Recalculate monthly total with new currency
        const grandTotalUSD = calculateMonthlyTotal();
        const totalAmount = selectedCurrency === 'KRW' ? grandTotalUSD * currentExchangeRate : grandTotalUSD;
        animateCounter(document.getElementById('totalEarnings'), totalAmount, selectedCurrency);
      });
      
      function calculateMonthlyTotal() {
        // Calculate total earnings for this month - sum all session earnings
        let grandTotalUSD = 0;
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth();
        
        const allWeeks = Storage.getAllWeeks();
        allWeeks.forEach(weekKey => {
          const sessions = Storage.getSessionsByWeek(weekKey);
          if (!sessions) return;
          
          sessions.forEach(s => {
            if (!s.studentId || !s.startTime || !s.endTime) return;
            
            // Parse date from dateISO
            const sessionDateStr = s.dateISO.slice(0, 10); // YYYY-MM-DD
            const sessionYear = parseInt(sessionDateStr.slice(0, 4));
            const sessionMonth = parseInt(sessionDateStr.slice(5, 7)) - 1; // Month is 0-indexed
            
            // Check if session is in current month
            if (sessionYear === currentYear && sessionMonth === currentMonth) {
              try {
                const students = Storage.getStudents();
                const student = students.find(st => st.id === s.studentId);
                if (!student) return;
                
                const dateStr = s.dateISO.slice(0, 10);
                const hrs = App.hoursBetween(`${dateStr}T${s.startTime}`, `${dateStr}T${s.endTime}`);
                if (hrs <= 0 || isNaN(hrs) || !isFinite(hrs)) return;
                
                const rate = student.rate || 0;
                const studentCurrency = student.currency || 'USD';
                
                // Convert student rate to USD for calculation
                let rateUSD = rate;
                if (studentCurrency === 'KRW') {
                  rateUSD = rate / currentExchangeRate;
                }
                
                grandTotalUSD += hrs * rateUSD;
              } catch (error) {
                // Skip this session if calculation fails
              }
            }
          });
        });
        
        return grandTotalUSD;
      }

      // Initialize
      init();
    </script>
  </body>
</html>


