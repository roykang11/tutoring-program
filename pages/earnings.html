<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Earnings</title>
    <link rel="stylesheet" href="../styles.css">
  </head>
  <body>
    <header class="app-header">
      <div class="header-left">
      <div class="currency-selector">
        <label>Currency:</label>
        <select id="currencySelect">
            <option value="USD">USD ($)</option>
            <option value="KRW">KRW (â‚©)</option>
        </select>
        <span id="conversionRate" class="conversion-rate"></span>
      </div>
        </div>
      <nav class="nav">
        <a href="./calendar.html">Weekly Calendar</a>
        <a href="./students.html">Students</a>
        <a href="./earnings.html">Earnings</a>
      </nav>
    </header>
    <main class="container">
      <div class="toolbar card">
        <label>Week</label>
        <select id="weekSelect"></select>
        <div class="spacer"></div>
        <div class="badge" id="totalWeek"></div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Student</th>
              <th>Hours</th>
              <th>Rate</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="earningsBody"></tbody>
          <tfoot>
            <tr>
              <th colspan="3" style="text-align:right">Net total</th>
              <th id="netTotal"></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="card" style="margin-top:16px; text-align:center; padding:32px; background: linear-gradient(135deg, #FFD700, #FFA500); border: 3px solid #B8860B; box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);">
        <h2 style="margin-bottom:20px; color:#8B4513; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-size:24px; font-weight:700">ðŸ’° TOTAL EARNINGS ðŸ’°</h2>
        <div id="totalEarnings" style="font-size:64px; font-weight:900; color:#8B4513; font-family:'Courier New', monospace; letter-spacing:4px; margin:24px 0; text-shadow: 3px 3px 6px rgba(0,0,0,0.4); transform: perspective(500px) rotateX(15deg);">
          â‚©0
        </div>
        <div class="muted" style="font-size:16px; color:#8B4513; font-weight:600; text-shadow: 1px 1px 2px rgba(0,0,0,0.2)">Net combined for this month</div>
        <div style="margin-top:12px; font-size:14px; color:#8B4513; font-style:italic; opacity:0.9">"Teaching minds, earning coins, living the dream! ðŸŽ“ðŸ’°"</div>
      </div>
    </main>

    <script src="../js/globals.js"></script>
    <script>

      const weekSelect = document.getElementById('weekSelect');
      const body = document.getElementById('earningsBody');
      const currencySelect = document.getElementById('currencySelect');
      const conversionRateDiv = document.getElementById('conversionRate');
      
      let currentExchangeRate = 1300; // Default fallback rate
      let selectedCurrency = 'USD';

      // Get real-time USD to KRW exchange rate
      async function getExchangeRate() {
        try {
          const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
          const data = await response.json();
          currentExchangeRate = data.rates.KRW;
          updateConversionRateDisplay();
          return currentExchangeRate;
        } catch (error) {
          console.log('Using fallback exchange rate:', currentExchangeRate);
          updateConversionRateDisplay();
          return currentExchangeRate;
        }
      }

      function updateConversionRateDisplay() {
        if (selectedCurrency === 'KRW') {
          conversionRateDiv.textContent = `1 USD = â‚©${Math.round(currentExchangeRate).toLocaleString()}`;
        } else {
          conversionRateDiv.textContent = `1 USD = â‚©${Math.round(currentExchangeRate).toLocaleString()}`;
        }
      }

      function convertCurrency(amountUSD) {
        if (selectedCurrency === 'KRW') {
          return Math.round(amountUSD * currentExchangeRate);
        }
        return amountUSD;
      }

      function formatCurrency(amountUSD) {
        const amount = convertCurrency(amountUSD);
        if (selectedCurrency === 'KRW') {
          return `â‚©${amount.toLocaleString()}`;
        }
        return `$${amount.toFixed(2)}`;
      }

      function populateWeeks() {
        const weeks = Storage.getAllWeeks();
        weekSelect.innerHTML = weeks.map(w => `<option value="${w}">${w}</option>`).join('');
      }

      function render() {
        const students = Storage.getStudents();
        const map = Object.fromEntries(students.map(s => [s.id, s]));
        const weekKey = weekSelect.value || Storage.getAllWeeks().slice(-1)[0];
        if (!weekKey) { body.innerHTML = '<tr><td colspan="4" class="muted">No data yet.</td></tr>'; return; }
        const sessions = Storage.getSessionsByWeek(weekKey);
        const byStudent = new Map();
        sessions.forEach(s => {
          const hrs = App.hoursBetween(`${s.dateISO.slice(0,10)}T${s.startTime || '00:00'}`, `${s.dateISO.slice(0,10)}T${s.endTime || '00:00'}`);
          byStudent.set(s.studentId, (byStudent.get(s.studentId) || 0) + hrs);
        });
        let net = 0;
        body.innerHTML = Array.from(byStudent.entries()).map(([sid, hrs]) => {
          const st = map[sid];
          const rate = (st?.rate) || 0;
          const studentCurrency = st?.currency || 'USD';
            
          // Convert student rate to USD for calculation
          let rateUSD = rate;
          if (studentCurrency === 'KRW') {
            rateUSD = rate / currentExchangeRate;
            }
            
          const totalUSD = hrs * rateUSD;
          net += totalUSD;
          
          // Format display based on selected currency
          const displayRate = selectedCurrency === 'KRW' ? rateUSD * currentExchangeRate : rateUSD;
          const displayTotal = selectedCurrency === 'KRW' ? totalUSD * currentExchangeRate : totalUSD;
          
          const studentName = st?.name || sid;
          const colorDot = st?.color ? `<span class="color-dot" style="background:${st.color}; margin-right: 8px;"></span>` : '';
          return `<tr><td>${colorDot}${studentName}</td><td>${hrs.toFixed(2)}</td><td>${formatCurrency(displayRate)}</td><td>${formatCurrency(displayTotal)}</td></tr>`;
        }).join('');
          
        // Show both USD and KRW for net total
        const netKRW = Math.round(net * currentExchangeRate);
        document.getElementById('netTotal').textContent = `${formatCurrency(net)} (â‚©${netKRW.toLocaleString()})`;
        document.getElementById('totalWeek').textContent = `${weekKey}`;
        
        // Calculate total earnings for this month
        let grandTotal = 0;
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        
        const allWeeks = Storage.getAllWeeks();
        allWeeks.forEach(wk => {
          // Extract date from week key (format: week:MM/DD/YYYY)
          const weekDateStr = wk.replace('week:', '');
          const weekDate = new Date(weekDateStr);
          
          // Only include weeks from current month
          if (weekDate.getMonth() === currentMonth && weekDate.getFullYear() === currentYear) {
            const weekSessions = Storage.getSessionsByWeek(wk);
            const weekByStudent = new Map();
            weekSessions.forEach(s => {
              const hrs = App.hoursBetween(`${s.dateISO.slice(0,10)}T${s.startTime || '00:00'}`, `${s.dateISO.slice(0,10)}T${s.endTime || '00:00'}`);
              weekByStudent.set(s.studentId, (weekByStudent.get(s.studentId) || 0) + hrs);
            });
            weekByStudent.forEach((hrs, sid) => {
              const st = map[sid];
              const rate = (st?.rate) || 0;
              const studentCurrency = st?.currency || 'USD';
          
              // Convert student rate to USD for calculation
              let rateUSD = rate;
              if (studentCurrency === 'KRW') {
                rateUSD = rate / currentExchangeRate;
          }
          
              grandTotal += hrs * rateUSD;
            });
          }
        });
        
        // Animate the total earnings counter (always in Won)
        const totalAmountWon = grandTotal * currentExchangeRate;
        animateCounter(document.getElementById('totalEarnings'), totalAmountWon);
      }
      
      function animateCounter(element, target) {
        const start = 0;
        const duration = 2000;
        const startTime = performance.now();
        
        function update(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const easeOut = 1 - Math.pow(1 - progress, 3);
          const current = start + (target - start) * easeOut;
          
          element.textContent = `â‚©${Math.floor(current).toLocaleString()}`;
          
          if (progress < 1) {
            requestAnimationFrame(update);
          }
        }
        
        requestAnimationFrame(update);
      }

      // Initialize currency functionality
      async function init() {
        await getExchangeRate();
        populateWeeks();
        render();
      }

      // Event listeners
      weekSelect.addEventListener('change', render);
      currencySelect.addEventListener('change', (e) => {
        selectedCurrency = e.target.value;
        updateConversionRateDisplay();
        render();
      });

      // Initialize the page
      init();
    </script>
  </body>
</html>


