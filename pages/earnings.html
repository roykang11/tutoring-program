<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Earnings</title>
    <link rel="stylesheet" href="../styles.css">
  </head>
  <body>
    <header class="app-header">
      <div class="header-left">
        <div class="date-nav">
          <button id="prevWeek" class="nav-btn">â€¹</button>
          <span id="currentWeek" class="current-week">October 2025</span>
          <button id="nextWeek" class="nav-btn">â€º</button>
          <button id="todayBtn" class="today-btn">Today</button>
        </div>
        <div class="week-selector" style="margin-left: 24px;">
          <label for="weekSelect" style="font-size: 13px; color: var(--muted); margin-right: 8px; font-weight: 500;">Week:</label>
          <select id="weekSelect" style="background: white; border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; font-size: 13px; color: var(--fg); cursor: pointer; min-width: 200px;">
            <option value="">Select a week...</option>
          </select>
        </div>
        <div class="currency-selector" style="margin-left: 24px;">
          <label>Currency:</label>
          <select id="currencySelect">
              <option value="USD">USD ($)</option>
              <option value="KRW">KRW (â‚©)</option>
          </select>
          <span id="conversionRate" class="conversion-rate"></span>
        </div>
      </div>
      <nav class="nav">
        <a href="./calendar.html">Weekly Calendar</a>
        <a href="./students.html">Students</a>
        <a href="./earnings.html">Earnings</a>
      </nav>
    </header>
    <main class="container">
      <div class="toolbar card">
        <div class="spacer"></div>
        <div class="badge" id="totalWeek"></div>
      </div>

      <div class="card">
        <table>
          <thead>
            <tr>
              <th>Student</th>
              <th>Hours</th>
              <th>Rate</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="earningsBody"></tbody>
          <tfoot>
            <tr>
              <th colspan="3" style="text-align:right">Net total</th>
              <th id="netTotal"></th>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="card" style="margin-top:16px; text-align:center; padding:32px; background: linear-gradient(135deg, #FFD700, #FFA500); border: 3px solid #B8860B; box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);">
        <h2 style="margin-bottom:20px; color:#8B4513; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-size:24px; font-weight:700">ðŸ’° TOTAL EARNINGS ðŸ’°</h2>
        <div id="totalEarnings" style="font-size:64px; font-weight:900; color:#8B4513; font-family:'Courier New', monospace; letter-spacing:4px; margin:24px 0; text-shadow: 3px 3px 6px rgba(0,0,0,0.4); transform: perspective(500px) rotateX(15deg);">
          â‚©0
        </div>
        <div class="muted" style="font-size:16px; color:#8B4513; font-weight:600; text-shadow: 1px 1px 2px rgba(0,0,0,0.2)">Net combined for this month</div>
        <div style="margin-top:12px; font-size:14px; color:#8B4513; font-style:italic; opacity:0.9">"Teaching minds, earning coins, living the dream! ðŸŽ“ðŸ’°"</div>
      </div>
    </main>

    <script src="../js/globals.js"></script>
    <script>

      const weekSelect = document.getElementById('weekSelect');
      const body = document.getElementById('earningsBody');
      const currencySelect = document.getElementById('currencySelect');
      const conversionRateDiv = document.getElementById('conversionRate');
      const currentWeek = document.getElementById('currentWeek');
      const prevWeekBtn = document.getElementById('prevWeek');
      const nextWeekBtn = document.getElementById('nextWeek');
      const todayBtn = document.getElementById('todayBtn');
      
      let currentExchangeRate = 1300; // Default fallback rate
      let selectedCurrency = 'USD';
      let currentWeekSunday = App.getSunday(new Date());

      // Get real-time USD to KRW exchange rate
      async function getExchangeRate() {
        try {
          const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
          const data = await response.json();
          currentExchangeRate = data.rates.KRW;
          updateConversionRateDisplay();
          return currentExchangeRate;
        } catch (error) {
          console.log('Using fallback exchange rate:', currentExchangeRate);
          updateConversionRateDisplay();
          return currentExchangeRate;
        }
      }

      function updateConversionRateDisplay() {
        if (selectedCurrency === 'KRW') {
          conversionRateDiv.textContent = `1 USD = â‚©${Math.round(currentExchangeRate).toLocaleString()}`;
        } else {
          conversionRateDiv.textContent = `1 USD = â‚©${Math.round(currentExchangeRate).toLocaleString()}`;
        }
      }

      function convertCurrency(amountUSD) {
        if (selectedCurrency === 'KRW') {
          return Math.round(amountUSD * currentExchangeRate);
        }
        return amountUSD;
      }

      function formatCurrency(amountUSD) {
        const amount = convertCurrency(amountUSD);
        if (selectedCurrency === 'KRW') {
          return `â‚©${amount.toLocaleString()}`;
        }
        return `$${amount.toFixed(2)}`;
      }

      function renderWeekLabel() {
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const sunday = App.getSunday(currentWeekSunday);
        const saturday = App.addDays(sunday, 6);
        if (sunday.getMonth() === saturday.getMonth()) {
          currentWeek.textContent = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
        } else {
          currentWeek.textContent = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
        }
      }

      function populateWeeks() {
        const allWeeks = Storage.getAllWeeks();
        const currentWeekKey = App.getWeekKey(currentWeekSunday);
        
        // Generate weeks for the past year and next year (like calendar page)
        const weeks = [];
        const today = new Date();
        const startDate = new Date(today);
        startDate.setFullYear(today.getFullYear() - 1);
        startDate.setDate(1);
        
        let currentDate = App.getSunday(startDate);
        const endDate = new Date(today);
        endDate.setFullYear(today.getFullYear() + 1);
        endDate.setMonth(11, 31);
        
        while (currentDate <= endDate) {
          const weekKey = App.getWeekKey(currentDate);
          const weekLabel = formatWeekLabel(currentDate);
          weeks.push({ key: weekKey, label: weekLabel, date: new Date(currentDate) });
          currentDate = App.addDays(currentDate, 7);
        }
        
        weekSelect.innerHTML = '<option value="">Select a week...</option>';
        weeks.forEach(week => {
          const option = document.createElement('option');
          option.value = week.key;
          option.textContent = week.label;
          if (week.key === currentWeekKey) {
            option.selected = true;
          }
          weekSelect.appendChild(option);
        });
      }

      function formatWeekLabel(date) {
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const sunday = App.getSunday(date);
        const saturday = App.addDays(sunday, 6);
        if (sunday.getMonth() === saturday.getMonth()) {
          return `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
        } else {
          return `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
        }
      }

      function updateWeekSelector() {
        const currentWeekKey = App.getWeekKey(currentWeekSunday);
        weekSelect.value = currentWeekKey;
      }

      function render() {
        const students = Storage.getStudents();
        const map = Object.fromEntries(students.map(s => [s.id, s]));
        const weekKey = App.getWeekKey(currentWeekSunday);
        if (!weekKey) { 
          body.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center; padding:24px;">No data yet. Add sessions in the calendar to see earnings.</td></tr>'; 
          document.getElementById('netTotal').textContent = '$0.00';
          document.getElementById('totalWeek').textContent = 'No week selected';
          return; 
        }
        const sessions = Storage.getSessionsByWeek(weekKey);
        if (!sessions || sessions.length === 0) {
          body.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center; padding:24px;">No sessions for this week.</td></tr>';
          document.getElementById('netTotal').textContent = formatCurrency(0);
          document.getElementById('totalWeek').textContent = weekKey.replace('week:', '');
          return;
        }
        const byStudent = new Map();
        const sessionsWithoutTimes = [];
        sessions.forEach(s => {
          let hrs = 0;
          
          // Calculate hours if start and end times are available
          if (s.startTime && s.endTime) {
            hrs = App.hoursBetween(`${s.dateISO.slice(0,10)}T${s.startTime}`, `${s.dateISO.slice(0,10)}T${s.endTime}`);
          } else if (s.startTime) {
            // If only start time, assume 1 hour default
            hrs = 1;
          } else if (s.endTime) {
            // If only end time, assume 1 hour default
            hrs = 1;
          } else {
            // No times at all - use default 1 hour duration
            hrs = 1;
            sessionsWithoutTimes.push(s);
          }
          
          if (hrs > 0) {
            byStudent.set(s.studentId, (byStudent.get(s.studentId) || 0) + hrs);
          }
        });
        
        if (byStudent.size === 0) {
          body.innerHTML = '<tr><td colspan="4" class="muted" style="text-align:center; padding:24px;">No sessions for this week. Add sessions in the calendar.</td></tr>';
          document.getElementById('netTotal').textContent = formatCurrency(0);
          document.getElementById('totalWeek').textContent = weekKey.replace('week:', '');
          return;
        }
        
        // Remove any existing warnings
        const existingWarning = document.querySelector('.time-warning');
        if (existingWarning) {
          existingWarning.remove();
        }
        
        // Show warning if there are sessions without times (using default 1 hour)
        if (sessionsWithoutTimes.length > 0) {
          const warningDiv = document.createElement('div');
          warningDiv.className = 'card time-warning';
          warningDiv.style.marginTop = '16px';
          warningDiv.style.background = '#fff3cd';
          warningDiv.style.borderColor = '#ffc107';
          warningDiv.style.borderWidth = '1px';
          warningDiv.style.borderStyle = 'solid';
          warningDiv.style.padding = '12px 16px';
          warningDiv.style.fontSize = '13px';
          warningDiv.style.color = '#856404';
          warningDiv.innerHTML = `âš ï¸ ${sessionsWithoutTimes.length} session(s) without time data - using 1 hour default. Please add start/end times in the calendar.`;
          const container = document.querySelector('.container');
          const lastCard = container.querySelector('.card:last-of-type');
          if (lastCard) {
            container.insertBefore(warningDiv, lastCard);
          } else {
            container.appendChild(warningDiv);
          }
        }
        let net = 0;
        body.innerHTML = Array.from(byStudent.entries()).map(([sid, hrs]) => {
          const st = map[sid];
          const rate = (st?.rate) || 0;
          const studentCurrency = st?.currency || 'USD';
            
          // Convert student rate to USD for calculation
          let rateUSD = rate;
          if (studentCurrency === 'KRW') {
            rateUSD = rate / currentExchangeRate;
            }
            
          const totalUSD = hrs * rateUSD;
          net += totalUSD;
          
          // Format display based on selected currency
          const displayRate = selectedCurrency === 'KRW' ? rateUSD * currentExchangeRate : rateUSD;
          const displayTotal = selectedCurrency === 'KRW' ? totalUSD * currentExchangeRate : totalUSD;
          
          const studentName = st?.name || sid;
          const colorDot = st?.color ? `<span class="color-dot" style="background:${st.color}; margin-right: 8px;"></span>` : '';
          return `<tr><td>${colorDot}${studentName}</td><td>${hrs.toFixed(2)}</td><td>${formatCurrency(displayRate)}</td><td>${formatCurrency(displayTotal)}</td></tr>`;
        }).join('');
          
        // Show both USD and KRW for net total
        const netKRW = Math.round(net * currentExchangeRate);
        document.getElementById('netTotal').textContent = `${formatCurrency(net)} (â‚©${netKRW.toLocaleString()})`;
        // Format week key for display
        const weekDateStr = weekKey.replace('week:', '');
        const weekDate = new Date(weekDateStr + 'T00:00');
        if (!isNaN(weekDate.getTime())) {
          const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
          const sunday = weekDate;
          const saturday = App.addDays(sunday, 6);
          let weekLabel;
          if (sunday.getMonth() === saturday.getMonth()) {
            weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
          } else {
            weekLabel = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
          }
          document.getElementById('totalWeek').textContent = weekLabel;
        } else {
          document.getElementById('totalWeek').textContent = weekKey.replace('week:', '');
        }
        
        // Calculate total earnings for this month
        let grandTotal = 0;
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth();
        const currentYear = currentDate.getFullYear();
        
        const allWeeks = Storage.getAllWeeks();
        allWeeks.forEach(wk => {
          // Extract date from week key (format: week:YYYY-MM-DD)
          const weekDateStr = wk.replace('week:', '');
          const weekDate = new Date(weekDateStr + 'T00:00');
          
          // Skip if date is invalid
          if (isNaN(weekDate.getTime())) {
            return;
          }
          
          // Only include weeks from current month
          if (weekDate.getMonth() === currentMonth && weekDate.getFullYear() === currentYear) {
            const weekSessions = Storage.getSessionsByWeek(wk);
            const weekByStudent = new Map();
            weekSessions.forEach(s => {
              let hrs = 0;
              // Calculate hours if start and end times are available
              if (s.startTime && s.endTime) {
                hrs = App.hoursBetween(`${s.dateISO.slice(0,10)}T${s.startTime}`, `${s.dateISO.slice(0,10)}T${s.endTime}`);
              } else {
                // Default to 1 hour if times are missing
                hrs = 1;
              }
              if (hrs > 0) {
                weekByStudent.set(s.studentId, (weekByStudent.get(s.studentId) || 0) + hrs);
              }
            });
            weekByStudent.forEach((hrs, sid) => {
              const st = map[sid];
              const rate = (st?.rate) || 0;
              const studentCurrency = st?.currency || 'USD';
          
              // Convert student rate to USD for calculation
              let rateUSD = rate;
              if (studentCurrency === 'KRW') {
                rateUSD = rate / currentExchangeRate;
              }
          
              grandTotal += hrs * rateUSD;
            });
          }
        });
        
        // Animate the total earnings counter (always in Won)
        const totalAmountWon = grandTotal * currentExchangeRate;
        animateCounter(document.getElementById('totalEarnings'), totalAmountWon);
      }
      
      function animateCounter(element, target) {
        const start = 0;
        const duration = 2000;
        const startTime = performance.now();
        
        function update(currentTime) {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / duration, 1);
          const easeOut = 1 - Math.pow(1 - progress, 3);
          const current = start + (target - start) * easeOut;
          
          element.textContent = `â‚©${Math.floor(current).toLocaleString()}`;
          
          if (progress < 1) {
            requestAnimationFrame(update);
          }
        }
        
        requestAnimationFrame(update);
      }


      // Event listeners
      prevWeekBtn.addEventListener('click', () => {
        currentWeekSunday.setDate(currentWeekSunday.getDate() - 7);
        renderWeekLabel();
        updateWeekSelector();
        render();
      });
      
      nextWeekBtn.addEventListener('click', () => {
        currentWeekSunday.setDate(currentWeekSunday.getDate() + 7);
        renderWeekLabel();
        updateWeekSelector();
        render();
      });
      
      todayBtn.addEventListener('click', () => {
        currentWeekSunday = App.getSunday(new Date());
        renderWeekLabel();
        updateWeekSelector();
        render();
      });
      
      weekSelect.addEventListener('change', (e) => {
        const selectedKey = e.target.value;
        if (selectedKey) {
          const dateStr = selectedKey.replace('week:', '');
          currentWeekSunday = new Date(dateStr + 'T00:00');
          renderWeekLabel();
          render();
        }
      });
      
      currencySelect.addEventListener('change', (e) => {
        selectedCurrency = e.target.value;
        updateConversionRateDisplay();
        render();
      });

      // Initialize the page
      async function init() {
        await getExchangeRate();
        renderWeekLabel();
        populateWeeks();
        render();
      }

      init();
    </script>
  </body>
</html>


