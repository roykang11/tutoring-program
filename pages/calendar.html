<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Weekly Calendar</title>
    <link rel="stylesheet" href="../styles.css">
  </head>
  <body>
    <header class="app-header">
      <div class="header-left">
        <div class="date-nav">
          <button id="prevWeek" class="nav-btn">‹</button>
          <span id="currentWeek" class="current-week" style="min-width: 180px; display: inline-block; text-align: center;">October 2025</span>
          <button id="nextWeek" class="nav-btn">›</button>
          <button id="todayBtn" class="today-btn">Today</button>
        </div>
        <div class="week-selector" style="margin-left: 24px;">
          <label for="weekSelect" style="font-size: 13px; color: var(--muted); margin-right: 8px; font-weight: 500;">Week:</label>
          <select id="weekSelect" style="background: white; border: 1px solid var(--border); border-radius: 6px; padding: 6px 12px; font-size: 13px; color: var(--fg); cursor: pointer; min-width: 200px;">
            <option value="">Select a week...</option>
          </select>
        </div>
      </div>
      <nav class="nav">
        <a href="./calendar.html">Weekly Calendar</a>
        <a href="./students.html">Students</a>
        <a href="./earnings.html">Earnings</a>
      </nav>
    </header>
    <main class="calendar-container">
      <div class="calendar-grid">
        <table id="calendarTable">
          <thead id="calendarHead"></thead>
          <tbody id="calendarBody"></tbody>
        </table>
      </div>
    </main>

    <script src="../js/globals.js"></script>
    <script>

      const currentWeek = document.getElementById('currentWeek');
      const head = document.getElementById('calendarHead');
      const body = document.getElementById('calendarBody');
      const weekSelect = document.getElementById('weekSelect');

      let currentWeekSunday = App.getSunday(new Date());

      function renderWeekLabel() {
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const sunday = App.getSunday(currentWeekSunday);
        const saturday = App.addDays(sunday, 6);
        
        // Format as "Oct 27 - Nov 2, 2025" or "Oct 27 - Oct 31, 2025" if same month
        if (sunday.getMonth() === saturday.getMonth()) {
          currentWeek.textContent = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
        } else {
          currentWeek.textContent = `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
        }
      }

      function populateWeekSelector() {
        const allWeeks = Storage.getAllWeeks();
        const currentWeekKey = App.getWeekKey(currentWeekSunday);
        
        // Generate weeks for the past year and next year
        const weeks = [];
        const today = new Date();
        const startDate = new Date(today);
        startDate.setFullYear(today.getFullYear() - 1);
        startDate.setDate(1); // Start from beginning of month
        
        // Generate all weeks from a year ago to a year ahead
        let currentDate = App.getSunday(startDate);
        const endDate = new Date(today);
        endDate.setFullYear(today.getFullYear() + 1);
        endDate.setMonth(11, 31);
        
        while (currentDate <= endDate) {
          const weekKey = App.getWeekKey(currentDate);
          const weekLabel = formatWeekLabel(currentDate);
          weeks.push({ key: weekKey, label: weekLabel, date: new Date(currentDate) });
          currentDate = App.addDays(currentDate, 7);
        }
        
        weekSelect.innerHTML = '<option value="">Select a week...</option>';
        weeks.forEach(week => {
          const option = document.createElement('option');
          option.value = week.key;
          option.textContent = week.label;
          if (week.key === currentWeekKey) {
            option.selected = true;
          }
          weekSelect.appendChild(option);
        });
      }

      function formatWeekLabel(date) {
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const sunday = App.getSunday(date);
        const saturday = App.addDays(sunday, 6);
        
        // If same month, show: "Oct 27 - Nov 2, 2025"
        // If different months, show: "Oct 27 - Nov 2, 2025"
        if (sunday.getMonth() === saturday.getMonth()) {
          return `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${saturday.getDate()}, ${sunday.getFullYear()}`;
        } else {
          return `${monthNames[sunday.getMonth()]} ${sunday.getDate()} - ${monthNames[saturday.getMonth()]} ${saturday.getDate()}, ${sunday.getFullYear()}`;
        }
      }

      function renderTable() {
        // header
        const days = Array.from({ length: 7 }, (_, i) => App.addDays(currentWeekSunday, i));
        head.innerHTML = '';
        const tr = document.createElement('tr');
        
        // First column: "Student"
        const thStudent = document.createElement('th');
        thStudent.textContent = 'Student';
        thStudent.className = 'student-header-col';
        tr.appendChild(thStudent);
        
        // Day columns
        days.forEach(d => {
          const th = document.createElement('th');
          const dayName = d.toLocaleDateString(undefined, { weekday: 'short' });
          const monthName = d.toLocaleDateString(undefined, { month: 'short' });
          const dayNum = d.getDate();
          th.innerHTML = `${dayName}, ${monthName} ${dayNum}`;
          tr.appendChild(th);
        });
        head.appendChild(tr);

        // body - one row per student
        body.innerHTML = '';
        const students = Storage.getStudents();
        const weekKey = App.getWeekKey(currentWeekSunday);
        const sessions = Storage.getSessionsByWeek(weekKey);
        const studentsById = Object.fromEntries(students.map(s => [s.id, s]));

        if (students.length === 0) {
          // Show message when no students
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.colSpan = 8;
          cell.className = 'no-students-message';
          cell.textContent = 'No students yet. Use the inputs above to add one.';
          row.appendChild(cell);
          body.appendChild(row);
        } else {
          // Create a row for each student
          students.forEach(student => {
            const row = document.createElement('tr');
            
            // Student name cell
            const studentCell = document.createElement('td');
            studentCell.className = 'student-col-cell';
            studentCell.innerHTML = `<span class="color-dot" style="background:${student.color || '#c7d2fe'}"></span>${student.name}`;
            row.appendChild(studentCell);
            
            // Day cells
          days.forEach(d => {
            const cell = document.createElement('td');
              cell.className = 'day-cell';
            cell.dataset.dateIso = new Date(d.getFullYear(), d.getMonth(), d.getDate()).toISOString();
              cell.dataset.studentId = student.id;
              
              // Find sessions for this student on this day
              const daySessions = sessions.filter(s => {
                if (s.studentId !== student.id) return false;
                // Parse date directly from ISO string to avoid timezone conversion
                const sessionDateStr = s.dateISO.slice(0, 10); // YYYY-MM-DD
                const sessionYear = parseInt(sessionDateStr.slice(0, 4));
                const sessionMonth = parseInt(sessionDateStr.slice(5, 7)) - 1; // Month is 0-indexed
                const sessionDay = parseInt(sessionDateStr.slice(8, 10));
                const sessionDate = new Date(sessionYear, sessionMonth, sessionDay);
                // Normalize both dates to midnight for comparison
                const dayToMatch = new Date(d.getFullYear(), d.getMonth(), d.getDate());
                return sessionDate.getTime() === dayToMatch.getTime();
              });
              
              // Display sessions in the cell
              if (daySessions.length > 0) {
                daySessions.forEach(session => {
                  const sessionDiv = document.createElement('div');
                  sessionDiv.className = 'session-pill';
                  sessionDiv.style.backgroundColor = `${student.color || '#3b82f6'}22`;
                  sessionDiv.style.borderLeft = `3px solid ${student.color || '#3b82f6'}`;
                  sessionDiv.style.cursor = 'pointer';
                  
                  const timeStr = session.startTime && session.endTime 
                    ? `${session.startTime}–${session.endTime}` 
                    : (session.startTime || session.endTime || '');
                  
                  sessionDiv.innerHTML = `
                    <div style="font-weight: 500; margin-bottom: 2px;">${session.title || 'Class'}</div>
                    ${timeStr ? `<div style="font-size: 11px; color: #6b7280;">${timeStr}</div>` : ''}
                  `;
                  
                  sessionDiv.addEventListener('click', () => openModalFor(session.id));
                  cell.appendChild(sessionDiv);
                });
              }
              
              row.appendChild(cell);
            });
            
            body.appendChild(row);
          });
        }
      }

      // Modal for editing a class
      const modalBackdrop = document.createElement('div');
      modalBackdrop.className = 'modal-backdrop';
      modalBackdrop.innerHTML = `
        <div class="modal">
          <header><strong>Edit Class</strong><button id="closeModal" class="ghost">✕</button></header>
          <div style="margin-bottom:8px; padding:8px; background:#f8f9fa; border-radius:4px" id="modalClassTitle">
            <!-- Class title will be displayed here -->
          </div>
          <div class="grid-2">
            <div>
              <label>Date</label>
              <input id="mDate" type="text" placeholder="MM/DD/YYYY" maxlength="10" />
            </div>
            <div>
              <label>Start</label>
              <input id="mStart" type="text" placeholder="HH:MM" maxlength="5" />
            </div>
            <div>
              <label>End</label>
              <input id="mEnd" type="text" placeholder="HH:MM" maxlength="5" />
            </div>
          </div>
          <div style="margin-top:8px">
            <label>Material covered</label>
            <textarea id="mMaterials" rows="3"></textarea>
          </div>
          <div style="margin-top:8px">
            <label>Notes</label>
            <textarea id="mNotes" rows="3"></textarea>
          </div>
          <footer>
            <button id="deleteClass" class="ghost">Delete</button>
            <div class="spacer"></div>
            <button id="saveClass">Save</button>
          </footer>
        </div>`;
      document.body.appendChild(modalBackdrop);

      function openModalFor(sessionId) {
        const weekKey = App.getWeekKey(currentWeekSunday);
        const sessions = Storage.getSessionsByWeek(weekKey);
        const idx = sessions.findIndex(s => s.id === sessionId);
        if (idx < 0) return;
        const s = sessions[idx];
        
        // Display class title (read-only, auto-numbered)
        const titleElement = document.getElementById('modalClassTitle');
        if (titleElement) {
          titleElement.innerHTML = `<strong>${s.title || 'Class'}</strong>`;
        }
        
        // Helper function to convert YYYY-MM-DD to MM/DD/YYYY for display
        function formatDateForDisplay(dateStr) {
          const match = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
          if (match) {
            return `${match[2]}/${match[3]}/${match[1]}`;
          }
          return dateStr;
        }
        
        document.getElementById('mDate').value = formatDateForDisplay(s.dateISO.slice(0,10));
        document.getElementById('mStart').value = s.startTime || '';
        document.getElementById('mEnd').value = s.endTime || '';
        document.getElementById('mMaterials').value = s.materials || '';
        document.getElementById('mNotes').value = s.notes || '';
        modalBackdrop.style.display = 'flex';
        
        // Setup date and time inputs
        setTimeout(() => {
          setupDateInput('mDate');
          setupTimeInput('mStart');
          setupTimeInput('mEnd');
        }, 100);

        const close = () => { modalBackdrop.style.display = 'none'; cleanup(); };
        const cleanup = () => {
          document.getElementById('closeModal').removeEventListener('click', close);
          document.getElementById('saveClass').removeEventListener('click', onSave);
          document.getElementById('deleteClass').removeEventListener('click', onDelete);
        };
        const onSave = () => {
          const newDateInput = document.getElementById('mDate').value;
          const newStartInput = document.getElementById('mStart').value;
          const newEndInput = document.getElementById('mEnd').value;
          
          const newDate = parseDateInput(newDateInput);
          const newStart = formatTimeInput(newStartInput);
          const newEnd = formatTimeInput(newEndInput);
          
          if (!newDate) {
            alert('Please enter a valid date (MM/DD/YYYY)');
            return;
          }
          if (!newStart) {
            alert('Please enter a valid start time (HH:MM)');
            return;
          }
          if (!newEnd) {
            alert('Please enter a valid end time (HH:MM)');
            return;
          }
          
          // Use the date string directly to avoid timezone issues
          const updatedDateISO = `${newDate}T00:00:00.000Z`;
          const updated = { ...s,
            // Keep the original title (auto-numbered, don't allow editing)
            dateISO: updatedDateISO,
            startTime: newStart,
            endTime: newEnd,
            materials: document.getElementById('mMaterials').value,
            notes: document.getElementById('mNotes').value,
          };
          // Move between weeks if date changed - use date object with noon to avoid timezone edge cases
          const dateObjForWeek = new Date(newDate + 'T12:00:00');
          const newWeekKey = App.getWeekKey(dateObjForWeek);
          if (newWeekKey !== weekKey) {
            sessions.splice(idx, 1);
            Storage.saveSessionsByWeek(weekKey, sessions);
            const other = Storage.getSessionsByWeek(newWeekKey);
            other.push(updated);
            Storage.saveSessionsByWeek(newWeekKey, other);
          } else {
            sessions[idx] = updated;
            Storage.saveSessionsByWeek(weekKey, sessions);
          }
          close();
        renderTable();
        };
        const onDelete = () => {
          if (!confirm('Delete this class?')) return;
          sessions.splice(idx, 1);
          Storage.saveSessionsByWeek(weekKey, sessions);
        close();
          renderTable();
        };
      document.getElementById('closeModal').addEventListener('click', close);
      document.getElementById('saveClass').addEventListener('click', onSave);
      document.getElementById('deleteClass').addEventListener('click', onDelete);
      }

      document.getElementById('prevWeek').addEventListener('click', () => { 
        currentWeekSunday.setDate(currentWeekSunday.getDate() - 7); 
        renderWeekLabel(); 
        renderTable();
        updateWeekSelector();
      });
      document.getElementById('nextWeek').addEventListener('click', () => { 
        currentWeekSunday.setDate(currentWeekSunday.getDate() + 7); 
        renderWeekLabel(); 
        renderTable();
        updateWeekSelector();
      });
      document.getElementById('todayBtn').addEventListener('click', () => { 
        currentWeekSunday = App.getSunday(new Date()); 
        renderWeekLabel(); 
        renderTable(); 
        updateWeekSelector();
      });
      
      function updateWeekSelector() {
        const currentWeekKey = App.getWeekKey(currentWeekSunday);
        weekSelect.value = currentWeekKey;
      }
      
      weekSelect.addEventListener('change', (e) => {
        const selectedKey = e.target.value;
        if (selectedKey) {
          // Parse the week key format: "week:YYYY-MM-DD"
          const dateStr = selectedKey.replace('week:', '');
          currentWeekSunday = new Date(dateStr + 'T00:00');
          renderWeekLabel();
          renderTable();
        }
      });

      // Open modal when clicking a class
      App.on(document, 'click', '.session-pill', (e, pill) => {
        const sessionId = pill.dataset.id;
        openModalFor(sessionId);
      });

      // Helper function to convert MM/DD/YYYY to YYYY-MM-DD
      function parseDateInput(dateStr) {
        // Try MM/DD/YYYY format
        const match = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
        if (match) {
          const month = parseInt(match[1]);
          const day = parseInt(match[2]);
          const year = parseInt(match[3]);
          if (month >= 1 && month <= 12 && day >= 1 && day <= 31 && year >= 1900 && year <= 2100) {
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          }
        }
        // If already in YYYY-MM-DD format, return as is
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
          return dateStr;
        }
        return null;
      }

      // Helper function to format time (HH:MM)
      function formatTimeInput(timeStr) {
        // If already in HH:MM format, return as is
        if (/^\d{2}:\d{2}$/.test(timeStr)) {
          return timeStr;
        }
        // If just digits, try to format
        const digits = timeStr.replace(/\D/g, '');
        if (digits.length >= 4) {
          return digits.slice(0, 2) + ':' + digits.slice(2, 4);
        }
        return null;
      }

      // Date input with auto-advance: MM -> DD -> YYYY
      function setupDateInput(inputId) {
        const input = document.getElementById(inputId);
        if (!input || input.tagName !== 'INPUT') return; // Only apply to input elements, not textareas
        
        let lastValue = '';
        let isOpeningPicker = false;
        
        // Helper to convert MM/DD/YYYY to YYYY-MM-DD
        function toDateInputFormat(value) {
          const match = value.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
          if (match) {
            const month = match[1].padStart(2, '0');
            const day = match[2].padStart(2, '0');
            const year = match[3];
            return `${year}-${month}-${day}`;
          }
          return '';
        }
        
        // Helper to convert YYYY-MM-DD to MM/DD/YYYY
        function fromDateInputFormat(value) {
          const match = value.match(/(\d{4})-(\d{2})-(\d{2})/);
          if (match) {
            return `${match[2]}/${match[3]}/${match[1]}`;
          }
          return value;
        }
        
        // Open date picker on click
        input.addEventListener('click', (e) => {
          // Only open picker if not typing
          if (isOpeningPicker) return;
          
          // Check if user is clicking to select text or if input is already focused
          if (document.activeElement === input && input.selectionStart !== input.selectionEnd) {
            return; // User is selecting text, don't open picker
          }
          
          // Small delay to distinguish between click and typing
          setTimeout(() => {
            if (document.activeElement === input) {
              // Create a temporary date input for the picker
              const tempInput = document.createElement('input');
              tempInput.type = 'date';
              tempInput.style.position = 'absolute';
              tempInput.style.opacity = '0';
              tempInput.style.pointerEvents = 'none';
              tempInput.style.width = '0';
              tempInput.style.height = '0';
              
              // Set value from current input
              const currentValue = input.value;
              if (currentValue) {
                const dateFormat = toDateInputFormat(currentValue);
                if (dateFormat) {
                  tempInput.value = dateFormat;
                }
              }
              
              document.body.appendChild(tempInput);
              
              // Show picker (if supported by browser)
              try {
                if (tempInput.showPicker) {
                  tempInput.showPicker();
                } else {
                  tempInput.focus();
                  tempInput.click();
                }
              } catch (e) {
                console.log('Date picker not supported, falling back to click');
                tempInput.focus();
                tempInput.click();
              }
              
              // Listen for changes
              tempInput.addEventListener('change', () => {
                if (tempInput.value) {
                  input.value = fromDateInputFormat(tempInput.value);
                  // Trigger input event for any listeners
                  input.dispatchEvent(new Event('input', { bubbles: true }));
                }
                document.body.removeChild(tempInput);
                isOpeningPicker = false;
              });
              
              // Remove on blur if cancelled
              tempInput.addEventListener('blur', () => {
                setTimeout(() => {
                  if (document.body.contains(tempInput)) {
                    document.body.removeChild(tempInput);
                    isOpeningPicker = false;
                  }
                }, 100);
              });
              
              isOpeningPicker = true;
            }
          }, 100);
        });
        
        input.addEventListener('input', (e) => {
          const target = e.target;
          let value = target.value.replace(/\D/g, ''); // Only digits
          
          // If user deleted, allow it
          if (target.value.length < lastValue.length) {
            lastValue = target.value;
            return;
          }
          
          if (value.length === 2 && lastValue.replace(/\D/g, '').length < 2) {
            // MM entered, add slash and auto-advance cursor
            target.value = value.slice(0, 2) + '/';
            // Move cursor to after the slash
            setTimeout(() => {
              target.setSelectionRange(3, 3);
            }, 0);
          } else if (value.length === 4 && lastValue.replace(/\D/g, '').length < 4) {
            // MMDD entered, add second slash and move to year
            target.value = value.slice(0, 2) + '/' + value.slice(2, 4) + '/';
            // Move cursor to after the second slash
            setTimeout(() => {
              target.setSelectionRange(6, 6);
            }, 0);
          } else if (value.length >= 8) {
            // MMDDYYYY entered, format complete
            target.value = value.slice(0, 2) + '/' + value.slice(2, 4) + '/' + value.slice(4, 8);
            // Move cursor to end
            setTimeout(() => {
              target.setSelectionRange(target.value.length, target.value.length);
            }, 0);
          }
          lastValue = target.value;
        });
        
        input.addEventListener('keydown', (e) => {
          // Only handle for this specific input element
          if (e.target !== input) return;
          
          // Allow backspace, delete, tab, arrow keys, enter
          if (['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Enter'].includes(e.key)) {
            return;
          }
          // Allow numbers
          if (e.key >= '0' && e.key <= '9') {
            return;
          }
          // Allow Ctrl/Cmd combinations (for copy/paste/undo)
          if (e.ctrlKey || e.metaKey) {
            return;
          }
          // Block other keys
          e.preventDefault();
        });
      }

      // Time input with auto-advance: HH -> MM
      function setupTimeInput(inputId) {
        const input = document.getElementById(inputId);
        if (!input || input.tagName !== 'INPUT') return; // Only apply to input elements, not textareas
        
        let lastValue = '';
        input.addEventListener('input', (e) => {
          const target = e.target;
          let value = target.value.replace(/\D/g, ''); // Only digits
          
          // If user deleted, allow it
          if (target.value.length < lastValue.length) {
            lastValue = target.value;
            return;
          }
          
          if (value.length === 2 && lastValue.replace(/\D/g, '').length < 2) {
            // HH entered, add colon and auto-advance cursor
            target.value = value.slice(0, 2) + ':';
            // Move cursor to after the colon
            setTimeout(() => {
              target.setSelectionRange(3, 3);
            }, 0);
          } else if (value.length >= 4) {
            // HHMM entered, format complete
            target.value = value.slice(0, 2) + ':' + value.slice(2, 4);
            // Move cursor to end
            setTimeout(() => {
              target.setSelectionRange(target.value.length, target.value.length);
            }, 0);
          }
          lastValue = target.value;
        });
        
        input.addEventListener('keydown', (e) => {
          // Only handle for this specific input element
          if (e.target !== input) return;
          
          // Allow backspace, delete, tab, arrow keys, enter
          if (['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Enter'].includes(e.key)) {
            return;
          }
          // Allow numbers
          if (e.key >= '0' && e.key <= '9') {
            return;
          }
          // Allow Ctrl/Cmd combinations (for copy/paste/undo)
          if (e.ctrlKey || e.metaKey) {
            return;
          }
          // Block other keys
          e.preventDefault();
        });
      }

      // init

      populateWeekSelector();
      renderWeekLabel();
      renderTable();
    </script>
  </body>
</html>


