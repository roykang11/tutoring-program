<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Student</title>
    <link rel="stylesheet" href="../styles.css">
  </head>
  <body>
    <header class="app-header">
      <div class="header-left">
      <h1 id="title">Student</h1>
      </div>
      <nav class="nav">
        <a href="./calendar.html">Weekly Calendar</a>
        <a href="./students.html">Students</a>
        <a href="./earnings.html">Earnings</a>
      </nav>
    </header>
    <main class="container with-side">
      <div class="card">
        <div class="row" style="justify-content: space-between">
          <div>
            <div><span class="color-dot" id="studentColorDot"></span><strong id="studentName"></strong></div>
            <div class="muted">Grade: <span id="studentGrade"></span> • Rate: <span id="studentRate"></span>/hr</div>
          </div>
          <div class="row">
            <button type="button" class="ghost" id="editStudent">Edit</button>
            <a class="btn ghost" href="./students.html">Back to Students</a>
          </div>
        </div>
      </div>

      <div class="card side-panel" style="height:fit-content">
        <h3>Add Class</h3>
        <div class="form-stack">
          <div>
            <label>Date</label>
            <input id="cDate" type="text" placeholder="MM/DD/YYYY" maxlength="10" />
          </div>
          <div>
            <label>Start</label>
            <input id="cStart" type="text" placeholder="HH:MM" maxlength="5" />
          </div>
          <div>
            <label>End</label>
            <input id="cEnd" type="text" placeholder="HH:MM" maxlength="5" />
          </div>
          </div>
        <div style="margin-top:8px">
          <label>Material covered</label>
          <textarea id="cMaterials" rows="3"></textarea>
          </div>
        <div style="margin-top:8px">
          <label>Notes</label>
          <textarea id="cNotes" rows="3"></textarea>
          </div>
        <div class="row" style="margin-top:8px; justify-content:flex-end">
          <button type="button" id="addClassBtn">Add Class</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Classes</h3>
        <hr style="margin:0 0 12px 0;border:none;border-top:1px solid var(--border)" />
        <div id="sessions" class="list two"></div>
      </div>
    </main>

    <script src="../js/globals.js"></script>
    <script>

      const studentId = App.readQuery('id');
      const students = Storage.getStudents();
      const student = students.find(s => s.id === studentId);
        if (!student) {
        alert('Student not found');
        location.href = './students.html';
      }
      document.getElementById('title').textContent = `Student: ${student.name}`;
        document.getElementById('studentName').textContent = student.name;
      document.getElementById('studentGrade').textContent = student.grade || '';
      document.getElementById('studentRate').textContent = App.currency(student.rate || 0);
      document.getElementById('studentColorDot').style.background = student.color || '#c7d2fe';

      // inline edit modal
      const modalBackdrop = document.createElement('div');
      modalBackdrop.className = 'modal-backdrop';
      modalBackdrop.innerHTML = `
        <div class="modal">
          <header><strong>Edit Student</strong><button id="closeStudentEdit" class="ghost">✕</button></header>
          <div class="grid-2" style="gap:16px">
            <div>
              <label>Name</label>
              <input id="pName" />
            </div>
            <div>
              <label>Grade</label>
              <input id="pGrade" />
            </div>
            <div>
              <label>Rate</label>
              <div style="display: flex; gap: 8px;">
                <input id="pRate" type="number" min="0" step="1" style="flex: 1;" />
                <select id="pCurrency" style="width: 80px;">
                  <option value="USD">USD</option>
                  <option value="KRW">KRW</option>
                </select>
              </div>
            </div>
            <div>
              <label>Color</label>
              <input id="pColor" type="color" />
            </div>
          </div>
          <footer>
            <button type="button" id="pDelete" class="ghost">Delete Student</button>
            <button type="button" id="pSave">Save</button>
          </footer>
        </div>`;
      document.body.appendChild(modalBackdrop);

      function openProfileEdit() {
        document.getElementById('pName').value = student.name;
        document.getElementById('pGrade').value = student.grade || '';
        document.getElementById('pRate').value = student.rate || 0;
        document.getElementById('pCurrency').value = student.currency || 'USD';
        document.getElementById('pColor').value = student.color || '#c7d2fe';
        modalBackdrop.style.display = 'flex';
      }
      function closeProfileEdit(){ modalBackdrop.style.display = 'none'; }
      document.getElementById('editStudent').addEventListener('click', openProfileEdit);
      document.getElementById('closeStudentEdit').addEventListener('click', closeProfileEdit);
      document.getElementById('pSave').addEventListener('click', () => {
        const students = Storage.getStudents();
        const idx = students.findIndex(s => s.id === studentId);
        if (idx < 0) return;
        students[idx] = {
          ...students[idx],
          name: document.getElementById('pName').value.trim() || students[idx].name,
          grade: document.getElementById('pGrade').value.trim(),
          rate: parseFloat(document.getElementById('pRate').value || '0') || 0,
          currency: document.getElementById('pCurrency').value,
          color: document.getElementById('pColor').value || '#c7d2fe',
        };
        Storage.saveStudents(students);
        closeProfileEdit();
        location.reload();
      });
      document.getElementById('pDelete').addEventListener('click', () => {
        if (!confirm('Delete this student?')) return;
        const students = Storage.getStudents();
        const next = students.filter(s => s.id !== studentId);
        Storage.saveStudents(next);
        location.href = './students.html';
      });

      function renderSessions() {
        const weeks = Storage.getAllWeeks();
        const container = document.getElementById('sessions');
        const allSessions = weeks.flatMap(w => Storage.getSessionsByWeek(w).map(s => ({ ...s, weekKey: w })));
        const mine = allSessions.filter(s => s.studentId === studentId);
        
        if (mine.length === 0) {
          container.innerHTML = '<div class="muted">No sessions yet. Add one from the calendar.</div>';
          return;
        }
        
        // Sort by creation order for numbering, but display recent first
        const sortedByCreation = mine.sort((a, b) => {
          const aTime = parseInt(a.id.split('_')[1]) || 0;
          const bTime = parseInt(b.id.split('_')[1]) || 0;
          return aTime - bTime; // oldest first for proper numbering
        });

        // Create a map of session ID to class number
        const classNumbers = {};
        sortedByCreation.forEach((s, index) => {
          classNumbers[s.id] = index + 1;
        });

        // Sort by date/time for display (recent first)
        const sortedForDisplay = mine.sort((a, b) => {
          // Parse date components directly to avoid timezone issues
          const aDateStr = a.dateISO.slice(0, 10);
          const aYear = parseInt(aDateStr.slice(0, 4));
          const aMonth = parseInt(aDateStr.slice(5, 7)) - 1;
          const aDay = parseInt(aDateStr.slice(8, 10));
          const aTime = (a.startTime || '00:00').split(':');
          const ta = new Date(aYear, aMonth, aDay, parseInt(aTime[0]) || 0, parseInt(aTime[1]) || 0).getTime();
          
          const bDateStr = b.dateISO.slice(0, 10);
          const bYear = parseInt(bDateStr.slice(0, 4));
          const bMonth = parseInt(bDateStr.slice(5, 7)) - 1;
          const bDay = parseInt(bDateStr.slice(8, 10));
          const bTime = (b.startTime || '00:00').split(':');
          const tb = new Date(bYear, bMonth, bDay, parseInt(bTime[0]) || 0, parseInt(bTime[1]) || 0).getTime();
          
          return tb - ta; // recent first
        });

        container.innerHTML = sortedForDisplay.map((s) => `
          <div class="item" style="margin-bottom:12px">
            <div class="row" style="justify-content:space-between; align-items:flex-start; margin-bottom:8px">
              <div>
                <div style="font-weight:600; font-size:14px">${s.title || `Class #${classNumbers[s.id]}`}</div>
                <div class="muted" style="font-size:12px">${formatDateForDisplay(s.dateISO.slice(0,10))} ${s.startTime || ''}–${s.endTime || ''}</div>
              </div>
              <div class="row" style="gap:6px">
                ${s.zoomLink ? `<a class="link" target="_blank" href="${s.zoomLink}" style="font-size:12px">Zoom</a>` : ''}
                <button class="ghost" data-action="edit" data-week="${s.weekKey}" data-id="${s.id}" style="font-size:12px">Edit</button>
                <button class="ghost" data-action="delete" data-week="${s.weekKey}" data-id="${s.id}" style="font-size:12px">Delete</button>
              </div>
            </div>
            <div class="grid-2" style="gap:8px">
              <div>
                <label style="font-size:11px">Materials covered</label>
                <div data-field="materials" data-id="${s.id}" style="font-size:12px; padding:8px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:6px; min-height:40px; white-space:pre-wrap;">${s.materials || 'No materials recorded'}</div>
              </div>
              <div>
                <label style="font-size:11px">Notes</label>
                <div data-field="notes" data-id="${s.id}" style="font-size:12px; padding:8px; background:#f8f9fa; border:1px solid #e9ecef; border-radius:6px; min-height:40px; white-space:pre-wrap;">${s.notes || 'No notes recorded'}</div>
              </div>
            </div>
          </div>
        `).join('');
      }

      // Event listener for session actions (edit/delete) - only set up once
      document.getElementById('sessions').addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        const action = btn.dataset.action;
        const weekKey = btn.dataset.week;
        const id = btn.dataset.id;
        const sessions = Storage.getSessionsByWeek(weekKey);
        const idx = sessions.findIndex(x => x.id === id);
        if (idx < 0) return;
        
        if (action === 'edit') {
          openClassEditModal(sessions[idx], weekKey, idx);
        } else if (action === 'delete') {
          if (!confirm('Delete this session?')) return;
          sessions.splice(idx, 1);
          Storage.saveSessionsByWeek(weekKey, sessions);
          renderSessions();
        }
      });

      renderSessions();

      // Function to add earnings to Italy savings when a class is created
      function addClassEarningsToSavings(session) {
        try {
          const students = Storage.getStudents();
          const student = students.find(s => s.id === session.studentId);
          if (!student || !session.startTime || !session.endTime) return;
          
          // Calculate hours and earnings
          const dateStr = session.dateISO.split('T')[0];
          const hrs = App.hoursBetween(`${dateStr}T${session.startTime}`, `${dateStr}T${session.endTime}`);
          if (hrs <= 0 || isNaN(hrs) || !isFinite(hrs)) return;
          
          const rate = student.rate || 0;
          const studentCurrency = student.currency || 'USD';
          
          // Convert to USD if needed
          let rateUSD = rate;
          if (studentCurrency === 'KRW') {
            // We need exchange rate - try to get it or use fallback
            let exchangeRate = 1300; // fallback
            try {
              // Try to read from localStorage if earnings page has been loaded
              const rateData = localStorage.getItem('tp:exchangeRate');
              if (rateData) exchangeRate = parseFloat(rateData);
            } catch (e) {}
            rateUSD = rate / exchangeRate;
          }
          
          const earningsUSD = hrs * rateUSD;
          if (earningsUSD > 0) {
            // Add transaction to savings
            const KEY_ITALY_TRANSACTIONS = 'tp:italyTransactions';
            let transactions = [];
            try {
              const raw = localStorage.getItem(KEY_ITALY_TRANSACTIONS);
              transactions = raw ? JSON.parse(raw) : [];
            } catch (e) {}
            
            const transaction = {
              id: `trans_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`,
              type: 'class',
              amount: earningsUSD,
              description: `Class earnings: ${session.title || 'Untitled'}`,
              sessionId: session.id,
              date: new Date().toISOString(),
              edited: false
            };
            transactions.push(transaction);
            localStorage.setItem(KEY_ITALY_TRANSACTIONS, JSON.stringify(transactions));
          }
        } catch (error) {
          console.error('Error adding class earnings to savings:', error);
        }
      }

        // Helper function to convert MM/DD/YYYY to YYYY-MM-DD
      function parseDateInput(dateStr) {
        // Try MM/DD/YYYY format
        const match = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
        if (match) {
          const month = parseInt(match[1]);
          const day = parseInt(match[2]);
          const year = parseInt(match[3]);
          if (month >= 1 && month <= 12 && day >= 1 && day <= 31 && year >= 1900 && year <= 2100) {
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          }
        }
        // If already in YYYY-MM-DD format, return as is
        if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
          return dateStr;
        }
        return null;
      }

      // Helper function to convert YYYY-MM-DD to MM/DD/YYYY for display
      function formatDateForDisplay(dateStr) {
        const match = dateStr.match(/(\d{4})-(\d{2})-(\d{2})/);
        if (match) {
          return `${match[2]}/${match[3]}/${match[1]}`;
        }
        return dateStr;
      }

      // Helper function to format time (HH:MM)
      function formatTimeInput(timeStr) {
        // If already in HH:MM format, return as is
        if (/^\d{2}:\d{2}$/.test(timeStr)) {
          return timeStr;
        }
        // If just digits, try to format
        const digits = timeStr.replace(/\D/g, '');
        if (digits.length >= 4) {
          return digits.slice(0, 2) + ':' + digits.slice(2, 4);
        }
        return null;
      }

      // add class form
      document.getElementById('addClassBtn').addEventListener('click', () => {
        const dateInput = document.getElementById('cDate').value;
        const startInput = document.getElementById('cStart').value;
        const endInput = document.getElementById('cEnd').value;
        const materials = document.getElementById('cMaterials').value;
        const notes = document.getElementById('cNotes').value;
        
        const date = parseDateInput(dateInput);
        const start = formatTimeInput(startInput);
        const end = formatTimeInput(endInput);
        
        if (!date) return alert('Please enter a valid date (MM/DD/YYYY)');
        if (!start) return alert('Please enter a valid start time (HH:MM)');
        if (!end) return alert('Please enter a valid end time (HH:MM)');
        
        // Automatically generate class number for this student
        const title = `Class #${getNextClassNumber()}`;
        
        // Use the date string directly (YYYY-MM-DD format)
        // This avoids timezone conversion issues
        const dateISO = `${date}T00:00:00.000Z`;
        // Create a date object for week key calculation using local timezone
        const dateObj = new Date(date + 'T12:00:00'); // Use noon to avoid timezone edge cases
        const wk = App.getWeekKey(dateObj);
        
        const sessions = Storage.getSessionsByWeek(wk);
        const newSession = { 
          id: `sess_${Date.now()}`, 
          studentId, 
          dateISO, 
          startTime: start, 
          endTime: end, 
          title, 
          materials, 
          notes, 
          zoomLink: '' 
        };
        sessions.push(newSession);
        Storage.saveSessionsByWeek(wk, sessions);
        
        document.getElementById('cDate').value = '';
        document.getElementById('cStart').value = '';
        document.getElementById('cEnd').value = '';
        document.getElementById('cMaterials').value = '';
        document.getElementById('cNotes').value = '';
        renderSessions();
      });

      function getNextClassNumber() {
        const weeks = Storage.getAllWeeks();
        const allSessions = weeks.flatMap(w => Storage.getSessionsByWeek(w));
        const studentSessions = allSessions.filter(s => s.studentId === studentId);
        return studentSessions.length + 1;
      }

      // Date input with auto-advance: MM -> DD -> YYYY
      function setupDateInput(inputId) {
        const input = document.getElementById(inputId);
        if (!input || input.tagName !== 'INPUT') return; // Only apply to input elements, not textareas
        
        let lastValue = '';
        let isOpeningPicker = false;
        
        // Helper to convert MM/DD/YYYY to YYYY-MM-DD
        function toDateInputFormat(value) {
          const match = value.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
          if (match) {
            const month = match[1].padStart(2, '0');
            const day = match[2].padStart(2, '0');
            const year = match[3];
            return `${year}-${month}-${day}`;
          }
          return '';
        }
        
        // Helper to convert YYYY-MM-DD to MM/DD/YYYY
        function fromDateInputFormat(value) {
          const match = value.match(/(\d{4})-(\d{2})-(\d{2})/);
          if (match) {
            return `${match[2]}/${match[3]}/${match[1]}`;
          }
          return value;
        }
        
        // Open date picker on click
        input.addEventListener('click', (e) => {
          // Only open picker if not typing
          if (isOpeningPicker) return;
          
          // Check if user is clicking to select text or if input is already focused
          if (document.activeElement === input && input.selectionStart !== input.selectionEnd) {
            return; // User is selecting text, don't open picker
          }
          
          // Small delay to distinguish between click and typing
          setTimeout(() => {
            if (document.activeElement === input) {
              // Create a temporary date input for the picker
              const tempInput = document.createElement('input');
              tempInput.type = 'date';
              tempInput.style.position = 'absolute';
              tempInput.style.opacity = '0';
              tempInput.style.pointerEvents = 'none';
              tempInput.style.width = '0';
              tempInput.style.height = '0';
              
              // Set value from current input
              const currentValue = input.value;
              if (currentValue) {
                const dateFormat = toDateInputFormat(currentValue);
                if (dateFormat) {
                  tempInput.value = dateFormat;
                }
              }
              
              document.body.appendChild(tempInput);
              
              // Show picker
              tempInput.showPicker();
              
              // Listen for changes
              tempInput.addEventListener('change', () => {
                if (tempInput.value) {
                  input.value = fromDateInputFormat(tempInput.value);
                  // Trigger input event for any listeners
                  input.dispatchEvent(new Event('input', { bubbles: true }));
                }
                document.body.removeChild(tempInput);
                isOpeningPicker = false;
              });
              
              // Remove on blur if cancelled
              tempInput.addEventListener('blur', () => {
                setTimeout(() => {
                  if (document.body.contains(tempInput)) {
                    document.body.removeChild(tempInput);
                    isOpeningPicker = false;
                  }
                }, 100);
              });
              
              isOpeningPicker = true;
            }
          }, 100);
        });
        
        input.addEventListener('input', (e) => {
          const target = e.target;
          let value = target.value.replace(/\D/g, ''); // Only digits
          
          // If user deleted, allow it
          if (target.value.length < lastValue.length) {
            lastValue = target.value;
            return;
          }
          
          if (value.length === 2 && lastValue.replace(/\D/g, '').length < 2) {
            // MM entered, add slash and auto-advance cursor
            target.value = value.slice(0, 2) + '/';
            // Move cursor to after the slash
            setTimeout(() => {
              target.setSelectionRange(3, 3);
            }, 0);
          } else if (value.length === 4 && lastValue.replace(/\D/g, '').length < 4) {
            // MMDD entered, add second slash and move to year
            target.value = value.slice(0, 2) + '/' + value.slice(2, 4) + '/';
            // Move cursor to after the second slash
            setTimeout(() => {
              target.setSelectionRange(6, 6);
            }, 0);
          } else if (value.length >= 8) {
            // MMDDYYYY entered, format complete
            target.value = value.slice(0, 2) + '/' + value.slice(2, 4) + '/' + value.slice(4, 8);
            // Move cursor to end
            setTimeout(() => {
              target.setSelectionRange(target.value.length, target.value.length);
            }, 0);
          }
          lastValue = target.value;
        });
        
        input.addEventListener('keydown', (e) => {
          // Only handle for this specific input element
          if (e.target !== input) return;
          
          // Allow backspace, delete, tab, arrow keys, enter
          if (['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Enter'].includes(e.key)) {
            return;
          }
          // Allow numbers
          if (e.key >= '0' && e.key <= '9') {
            return;
          }
          // Allow Ctrl/Cmd combinations (for copy/paste/undo)
          if (e.ctrlKey || e.metaKey) {
            return;
          }
          // Block other keys
          e.preventDefault();
        });
      }

      // Time input with auto-advance: HH -> MM
      function setupTimeInput(inputId) {
        const input = document.getElementById(inputId);
        if (!input || input.tagName !== 'INPUT') return; // Only apply to input elements, not textareas
        
        let lastValue = '';
        input.addEventListener('input', (e) => {
          const target = e.target;
          let value = target.value.replace(/\D/g, ''); // Only digits
          
          // If user deleted, allow it
          if (target.value.length < lastValue.length) {
            lastValue = target.value;
            return;
          }
          
          if (value.length === 2 && lastValue.replace(/\D/g, '').length < 2) {
            // HH entered, add colon and auto-advance cursor
            target.value = value.slice(0, 2) + ':';
            // Move cursor to after the colon
            setTimeout(() => {
              target.setSelectionRange(3, 3);
            }, 0);
          } else if (value.length >= 4) {
            // HHMM entered, format complete
            target.value = value.slice(0, 2) + ':' + value.slice(2, 4);
            // Move cursor to end
            setTimeout(() => {
              target.setSelectionRange(target.value.length, target.value.length);
            }, 0);
          }
          lastValue = target.value;
        });
        
        input.addEventListener('keydown', (e) => {
          // Only handle for this specific input element
          if (e.target !== input) return;
          
          // Allow backspace, delete, tab, arrow keys, enter
          if (['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'Enter'].includes(e.key)) {
            return;
          }
          // Allow numbers
          if (e.key >= '0' && e.key <= '9') {
            return;
          }
          // Allow Ctrl/Cmd combinations (for copy/paste/undo)
          if (e.ctrlKey || e.metaKey) {
            return;
          }
          // Block other keys
          e.preventDefault();
        });
      }
      
      // Setup inputs when page loads
      setupDateInput('cDate');
      setupTimeInput('cStart');
      setupTimeInput('cEnd');

      function openClassEditModal(session, weekKey, sessionIndex) {
        // Get class number for this session
        const weeks = Storage.getAllWeeks();
        const allSessions = weeks.flatMap(w => Storage.getSessionsByWeek(w));
        const studentSessions = allSessions.filter(s => s.studentId === session.studentId);
        const sortedByCreation = studentSessions.sort((a, b) => {
          const aTime = parseInt(a.id.split('_')[1]) || 0;
          const bTime = parseInt(b.id.split('_')[1]) || 0;
          return aTime - bTime;
        });
        const classNum = sortedByCreation.findIndex(s => s.id === session.id) + 1;
        
        const modalBackdrop = document.createElement('div');
        modalBackdrop.className = 'modal-backdrop';
        modalBackdrop.innerHTML = `
        <div class="modal">
            <header><strong>Edit Class</strong><button id="closeClassEdit" class="ghost">✕</button></header>
            <div style="margin-bottom:8px; padding:8px; background:#f8f9fa; border-radius:4px">
              <strong>${session.title || `Class #${classNum}`}</strong>
            </div>
            <div class="grid-2" style="gap:16px">
            <div>
              <label>Date</label>
                <input id="editDate" type="text" placeholder="MM/DD/YYYY" maxlength="10" />
            </div>
            <div>
              <label>Start Time</label>
                <input id="editStart" type="text" placeholder="HH:MM" maxlength="5" />
            </div>
            <div>
              <label>End Time</label>
                <input id="editEnd" type="text" placeholder="HH:MM" maxlength="5" />
            </div>
            </div>
            <div style="margin-top:16px">
              <label>Materials covered</label>
              <textarea id="editMaterials" rows="4"></textarea>
            </div>
            <div style="margin-top:16px">
              <label>Notes</label>
              <textarea id="editNotes" rows="4"></textarea>
          </div>
          <footer>
              <button type="button" id="saveClassEdit">Save</button>
          </footer>
          </div>`;
        
        document.body.appendChild(modalBackdrop);
        modalBackdrop.style.display = 'flex';
        
        // Set input and textarea values to avoid HTML injection issues
        document.getElementById('editDate').value = formatDateForDisplay(session.dateISO.slice(0,10));
        document.getElementById('editStart').value = session.startTime || '';
        document.getElementById('editEnd').value = session.endTime || '';
        document.getElementById('editMaterials').value = session.materials || '';
        document.getElementById('editNotes').value = session.notes || '';
        
        // Setup date and time inputs for edit modal
        setTimeout(() => {
          setupDateInput('editDate');
          setupTimeInput('editStart');
          setupTimeInput('editEnd');
        }, 100);
        
        // Close modal handlers
        document.getElementById('closeClassEdit').addEventListener('click', () => {
          document.body.removeChild(modalBackdrop);
        });
        
        modalBackdrop.addEventListener('click', (e) => {
          if (e.target === modalBackdrop) {
            document.body.removeChild(modalBackdrop);
          }
        });
        
        // Save handler
        document.getElementById('saveClassEdit').addEventListener('click', () => {
          const editDateInput = document.getElementById('editDate').value;
          const editStartInput = document.getElementById('editStart').value;
          const editEndInput = document.getElementById('editEnd').value;
          
          const editDate = parseDateInput(editDateInput);
          const editStart = formatTimeInput(editStartInput);
          const editEnd = formatTimeInput(editEndInput);
          
          if (!editDate) {
            alert('Please enter a valid date (MM/DD/YYYY)');
            return;
          }
          if (!editStart) {
            alert('Please enter a valid start time (HH:MM)');
            return;
          }
          if (!editEnd) {
            alert('Please enter a valid end time (HH:MM)');
            return;
          }
          
          const sessions = Storage.getSessionsByWeek(weekKey);
          // Use the date string directly to avoid timezone issues
          const updatedDateISO = `${editDate}T00:00:00.000Z`;
          
          // If the week changed, we need to move the session to the correct week
          const dateObjForWeek = new Date(editDate + 'T12:00:00'); // Use noon to avoid timezone edge cases
          const newWeekKey = App.getWeekKey(dateObjForWeek);
          
          // Update the session
          const updatedSession = {
            ...sessions[sessionIndex],
            // Keep the original title (auto-numbered, don't allow editing)
            dateISO: updatedDateISO,
            startTime: editStart,
            endTime: editEnd,
            materials: document.getElementById('editMaterials').value,
            notes: document.getElementById('editNotes').value
          };
          
          // If week changed, move session to new week
          if (newWeekKey !== weekKey) {
            sessions.splice(sessionIndex, 1);
            Storage.saveSessionsByWeek(weekKey, sessions);
            
            const newWeekSessions = Storage.getSessionsByWeek(newWeekKey);
            newWeekSessions.push(updatedSession);
            Storage.saveSessionsByWeek(newWeekKey, newWeekSessions);
          } else {
            sessions[sessionIndex] = updatedSession;
          Storage.saveSessionsByWeek(weekKey, sessions);
          }
          
          document.body.removeChild(modalBackdrop);
          renderSessions();
        });
      }
    </script>
  </body>
</html>


